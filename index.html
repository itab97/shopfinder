<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ShopFinder UK</title>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'DM Sans', sans-serif; background: linear-gradient(160deg, #faf8f4 0%, #f0ece4 100%); min-height: 100vh; }
        @keyframes spin { to { transform: rotate(360deg); } }

        .header { background: #1a1a2e; padding: 40px 20px 36px; text-align: center; border-bottom: 3px solid #c9a96e; }
        .header h1 { font-family: 'Playfair Display', serif; font-size: 30px; color: #e8d5b7; margin: 0 0 6px; letter-spacing: -0.5px; }
        .header p { color: rgba(232,213,183,0.5); font-size: 14px; }

        .container { max-width: 600px; margin: 0 auto; padding: 28px 20px; }

        .field-label { font-size: 11px; font-weight: 700; color: #999; text-transform: uppercase; letter-spacing: 0.5px; display: block; margin-bottom: 6px; }
        .field-label-mb8 { margin-bottom: 8px; }

        /* Toggle buttons (shop type + search mode) */
        .toggle-row { display: flex; gap: 8px; margin-bottom: 16px; }
        .toggle-btn {
            flex: 1; padding: 14px 12px; border-radius: 10px;
            border: 2px solid #e0dbd2; background: #fff; color: #555;
            cursor: pointer; text-align: center; transition: all 0.15s;
            font-family: 'DM Sans', sans-serif;
        }
        .toggle-btn.active { border-color: #1a1a2e; background: #1a1a2e; color: #e8d5b7; }
        .toggle-btn .label { font-size: 15px; font-weight: 600; }
        .toggle-btn .sublabel { font-size: 11px; margin-top: 2px; color: #aaa; }
        .toggle-btn.active .sublabel { color: rgba(232,213,183,0.6); }

        .toggle-row-sm { display: flex; gap: 6px; margin-bottom: 12px; }
        .toggle-btn-sm {
            flex: 1; padding: 9px 12px; border-radius: 8px;
            border: 2px solid #e0dbd2; background: #fff; color: #555;
            cursor: pointer; font-size: 13px; font-weight: 600;
            transition: all 0.15s; font-family: 'DM Sans', sans-serif;
        }
        .toggle-btn-sm.active { border-color: #1a1a2e; background: #1a1a2e; color: #e8d5b7; }

        .dropdown-wrapper { position: relative; margin-bottom: 12px; }
        .dropdown-input {
            width: 100%; padding: 13px 40px 13px 16px; border-radius: 10px;
            border: 2px solid #e0dbd2; font-size: 15px; outline: none;
            background: #fff; font-family: 'DM Sans', sans-serif;
        }
        .dropdown-clear {
            position: absolute; right: 14px; top: 50%; transform: translateY(-50%);
            cursor: pointer; color: #bbb; font-size: 18px; line-height: 1;
            background: none; border: none; display: none;
        }
        .dropdown-list {
            position: absolute; top: 100%; left: 0; right: 0; z-index: 50;
            background: #fff; border-radius: 0 0 10px 10px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.1); max-height: 220px;
            overflow-y: auto; border: 1px solid #e0dbd2; border-top: none; display: none;
        }
        .dropdown-list.open { display: block; }
        .dropdown-item { padding: 10px 16px; cursor: pointer; font-size: 14px; color: #333; }
        .dropdown-item:hover { background: #faf6ee; }
        .dropdown-empty { padding: 12px 16px; color: #aaa; font-size: 13px; }

        .text-input-wrapper { margin-bottom: 12px; }
        .text-input {
            width: 100%; padding: 13px 40px 13px 16px; border-radius: 10px;
            border: 2px solid #e0dbd2; font-size: 15px; outline: none;
            background: #fff; font-family: 'DM Sans', sans-serif;
        }
        .text-clear {
            position: absolute; right: 14px; top: 50%; transform: translateY(-50%);
            cursor: pointer; color: #bbb; font-size: 18px; line-height: 1;
            background: none; border: none;
        }

        .search-btn {
            width: 100%; padding: 13px 28px; border-radius: 10px; border: none;
            background: #1a1a2e; color: #e8d5b7; font-size: 15px; font-weight: 700;
            cursor: pointer; margin-bottom: 8px; font-family: 'DM Sans', sans-serif;
        }
        .search-btn:disabled { opacity: 0.4; cursor: not-allowed; }

        .hint { font-size: 12px; color: #c9a96e; text-align: center; margin: 4px 0 0; }

        .section-header { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; margin-top: 24px; }
        .section-icon {
            font-size: 20px; width: 36px; height: 36px; display: flex;
            align-items: center; justify-content: center; border-radius: 8px;
        }
        .section-title { font-weight: 700; font-size: 15px; color: #1a1a2e; }
        .section-count { font-size: 12px; color: #aaa; }
        .spinner {
            margin-left: auto; width: 18px; height: 18px;
            border: 2px solid #e0dbd2; border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        /* Online result card (text-only) */
        .result-card {
            display: block; background: #fff; border-radius: 8px; padding: 12px 16px;
            text-decoration: none; color: #1a1a2e; border: 1px solid #eee;
            transition: all 0.15s; margin-bottom: 6px;
        }
        .result-card:hover { box-shadow: 0 3px 12px rgba(0,0,0,0.07); border-color: #d0c9be; }
        .result-name { font-weight: 600; font-size: 14px; margin-bottom: 3px; line-height: 1.3; }
        .result-snippet { font-size: 12px; color: #888; line-height: 1.4; }
        .result-url { font-size: 11px; color: #b0a890; margin-top: 4px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

        /* Physical result card (with map thumbnail) */
        .physical-card {
            display: flex; gap: 12px; background: #fff; border-radius: 8px;
            padding: 10px 12px; text-decoration: none; color: #1a1a2e;
            border: 1px solid #eee; transition: all 0.15s; margin-bottom: 6px;
            align-items: center;
        }
        .physical-card:hover { box-shadow: 0 3px 12px rgba(0,0,0,0.07); border-color: #d0c9be; }
        .physical-card .category-icon {
            width: 56px; height: 56px; border-radius: 8px; background: #f8f5ef;
            flex-shrink: 0; display: flex; align-items: center; justify-content: center;
            font-size: 28px;
        }
        .physical-card .card-text { min-width: 0; flex: 1; }
        .physical-card .card-snippet {
            font-size: 12px; color: #888; line-height: 1.4;
            overflow: hidden; text-overflow: ellipsis;
            display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical;
        }

        .empty-state { text-align: center; padding: 40px 20px; }
        .empty-state .icon { font-size: 40px; margin-bottom: 12px; }
        .empty-state p { font-size: 14px; color: #bbb; }
        .no-results { color: #bbb; font-size: 13px; margin: 4px 0 0; padding: 8px 0; }

        .disclosure {
            font-size: 11px; color: #bbb; text-align: center;
            margin-top: 32px; padding: 12px 0; border-top: 1px solid #e8e2d8;
        }
        .disclosure a { color: #bbb; }

        .hidden { display: none !important; }
    </style>
</head>
<body>
    <div class="header">
        <div style="font-size: 36px; margin-bottom: 8px;">üõçÔ∏è</div>
        <h1>ShopFinder UK</h1>
        <p>Discover independent shops across the UK</p>
    </div>

    <div class="container">
        <!-- Shop Type Toggle -->
        <div>
            <label class="field-label field-label-mb8">Search for</label>
            <div class="toggle-row">
                <button class="toggle-btn" id="btnPhysical" data-type="physical">
                    <div class="label">üè™ Shops in your city</div>
                    <div class="sublabel">Experiences close by</div>
                </button>
                <button class="toggle-btn" id="btnOnline" data-type="online">
                    <div class="label">üåê Online shops in the UK</div>
                    <div class="sublabel">Low shipping costs</div>
                </button>
            </div>
        </div>

        <!-- Location (physical only) -->
        <div class="dropdown-wrapper hidden" id="locationWrapper">
            <label class="field-label">Your location</label>
            <div style="position:relative;">
                <input type="text" class="dropdown-input" id="locationInput" placeholder="Select a town or city..." autocomplete="off" />
                <button class="dropdown-clear" id="locationClear">√ó</button>
            </div>
            <div class="dropdown-list" id="locationList"></div>
        </div>

        <!-- Search By Toggle -->
        <div>
            <label class="field-label field-label-mb8">Search by</label>
            <div class="toggle-row-sm">
                <button class="toggle-btn-sm active" id="btnSearchCategory" data-mode="category">Category</button>
                <button class="toggle-btn-sm" id="btnSearchName" data-mode="name">Shop name</button>
            </div>
        </div>

        <!-- Category dropdown -->
        <div class="dropdown-wrapper" id="categoryWrapper">
            <label class="field-label">What are you looking for?</label>
            <div style="position:relative;">
                <input type="text" class="dropdown-input" id="categoryInput" placeholder="Select a category..." autocomplete="off" />
                <button class="dropdown-clear" id="categoryClear">√ó</button>
            </div>
            <div class="dropdown-list" id="categoryList"></div>
        </div>

        <!-- Shop name text input -->
        <div class="text-input-wrapper hidden" id="shopNameWrapper">
            <label class="field-label">Shop name</label>
            <div style="position:relative;">
                <input type="text" class="text-input" id="shopNameInput" placeholder="e.g. The Chocolate Factory, Bob's Books..." />
                <button class="text-clear" id="shopNameClear" style="display:none;">√ó</button>
            </div>
        </div>

        <button class="search-btn" id="searchBtn" disabled>Search</button>

        <div id="results"></div>

        <div class="empty-state" id="emptyState">
            <div class="icon">üîç</div>
            <p>Choose a shop type and category to get started</p>
        </div>

        <p class="disclosure">
            As an Etsy Affiliate, we earn from qualifying purchases.
        </p>
    </div>

    <script>
    // =============================================
    // CONFIGURATION ‚Äî Update these values
    // =============================================
    const WORKER_URL = "https://shopfinder-worker.shopfinder.workers.dev";

    const AWIN_PUBLISHER_ID = "000000";
    const AWIN_ETSY_ADVERTISER_ID = "6220";
    const RESULT_LIMIT = 10;
    // =============================================

    const CATEGORY_ICONS = {
        "Animals & Pets": "üêæ",
        "Antiques": "üè∫",
        "Arts and Crafts": "üé®",
        "Bakery": "üçû",
        "Beauty & Make-up": "üíÑ",
        "Beer, Wine & Spirits": "üç∑",
        "Booksellers": "üìö",
        "Cars & Motorbikes": "üöó",
        "Charity": "üíõ",
        "Chocolatier": "üç´",
        "Comics & Manga": "üí¨",
        "Computers and Televisions": "üíª",
        "Delicatessen": "ü•ñ",
        "Fashion & Clothing": "üëó",
        "Footwear": "üëü",
        "Gardening": "üå±",
        "Haberdashery (Sewing & Knitting)": "üßµ",
        "Jewellery": "üíé",
        "Meat, Fish and Cheeses": "ü•©üêüüßÄ"
        "Painting & Photography": "üñºÔ∏è",
        "Sports & Fitness": "‚öΩ",
        "Sweets & Confectionary": "üç¨",
        "Tea and Coffee": "‚òï",
        "Toys & Games": "üß∏",
        "Video Games": "üéÆ"
    };
    const CATEGORIES = Object.keys(CATEGORY_ICONS);

    const UK_LOCATIONS = [
        "Aberdeen","Bath","Belfast","Birmingham","Blackburn","Blackpool","Bolton","Bournemouth",
        "Bradford","Brighton","Bristol","Burnley","Cambridge","Canterbury","Cardiff","Carlisle",
        "Chelmsford","Cheltenham","Chester","Colchester","Coventry","Crawley","Darlington","Derby",
        "Doncaster","Dover","Dundee","Durham","Edinburgh","Exeter","Glasgow","Gloucester",
        "Grimsby","Guildford","Halifax","Harrogate","Huddersfield","Hull","Inverness","Ipswich",
        "Keighley","Lancaster","Leeds","Leicester","Lincoln","Liverpool","London","Luton",
        "Macclesfield","Manchester","Middlesbrough","Milton Keynes","Newcastle","Northampton",
        "Norwich","Nottingham","Oldham","Oxford","Perth","Peterborough","Plymouth","Portsmouth",
        "Preston","Reading","Rochdale","Rotherham","Saltaire","Scarborough","Sheffield","Shipley",
        "Shrewsbury","Skipton","Southampton","Southend","St Albans","Stockport","Stoke-on-Trent",
        "Sunderland","Swansea","Swindon","Taunton","Wakefield","Walsall","Warrington","Wigan",
        "Winchester","Wolverhampton","Worcester","York"
    ];

    // Affiliate URL helpers
    function etsyAffiliateUrl(url) {
        return "https://www.awin1.com/cread.php?awinmid=" + AWIN_ETSY_ADVERTISER_ID +
               "&awinaffid=" + AWIN_PUBLISHER_ID +
               "&ued=" + encodeURIComponent(url);
    }

    // No external APIs needed for category icons

    // State
    let shopType = "";        // "physical" or "online"
    let searchMode = "category"; // "category" or "name"
    let selectedLocation = "";
    let selectedCategory = "";
    let shopNameValue = "";
    let isSearching = false;

    // DOM refs
    const btnPhysical = document.getElementById("btnPhysical");
    const btnOnline = document.getElementById("btnOnline");
    const btnSearchCategory = document.getElementById("btnSearchCategory");
    const btnSearchName = document.getElementById("btnSearchName");
    const locationWrapper = document.getElementById("locationWrapper");
    const categoryWrapper = document.getElementById("categoryWrapper");
    const shopNameWrapper = document.getElementById("shopNameWrapper");
    const shopNameInput = document.getElementById("shopNameInput");
    const shopNameClear = document.getElementById("shopNameClear");
    const searchBtn = document.getElementById("searchBtn");
    const hintText = document.getElementById("hintText");
    const resultsDiv = document.getElementById("results");
    const emptyState = document.getElementById("emptyState");

    // Get the active search term
    function getSearchTerm() {
        return searchMode === "category" ? selectedCategory : shopNameValue.trim();
    }

    // Update button/hint state
    function updateUI() {
        const term = getSearchTerm();
        const canSearch = term && shopType && (shopType === "online" || selectedLocation);
        searchBtn.disabled = !canSearch || isSearching;
        searchBtn.textContent = isSearching ? "Searching..." : "Search";

        // Hints
        if (!shopType) {
            hintText.textContent = "Choose a shop type above to get started";
            hintText.classList.remove("hidden");
        } else if (shopType === "physical" && !selectedLocation && term) {
            hintText.textContent = "Select a location to search for physical shops";
            hintText.classList.remove("hidden");
        } else {
            hintText.classList.add("hidden");
        }
    }

    // Shop type toggle
    btnPhysical.addEventListener("click", function() {
        shopType = "physical";
        btnPhysical.classList.add("active");
        btnOnline.classList.remove("active");
        locationWrapper.classList.remove("hidden");
        updateUI();
    });
    btnOnline.addEventListener("click", function() {
        shopType = "online";
        btnOnline.classList.add("active");
        btnPhysical.classList.remove("active");
        locationWrapper.classList.add("hidden");
        updateUI();
    });

    // Search mode toggle
    btnSearchCategory.addEventListener("click", function() {
        searchMode = "category";
        btnSearchCategory.classList.add("active");
        btnSearchName.classList.remove("active");
        categoryWrapper.classList.remove("hidden");
        shopNameWrapper.classList.add("hidden");
        updateUI();
    });
    btnSearchName.addEventListener("click", function() {
        searchMode = "name";
        btnSearchName.classList.add("active");
        btnSearchCategory.classList.remove("active");
        shopNameWrapper.classList.remove("hidden");
        categoryWrapper.classList.add("hidden");
        updateUI();
    });

    // Shop name input
    shopNameInput.addEventListener("input", function() {
        shopNameValue = shopNameInput.value;
        shopNameClear.style.display = shopNameValue ? "block" : "none";
        updateUI();
    });
    shopNameClear.addEventListener("click", function() {
        shopNameValue = "";
        shopNameInput.value = "";
        shopNameClear.style.display = "none";
        updateUI();
    });

    // Dropdown logic
    function setupDropdown(inputEl, listEl, clearEl, items, onSelect, getSelected) {
        function renderList(filter) {
            const filtered = items.filter(function(item) {
                return item.toLowerCase().includes(filter.toLowerCase());
            });
            listEl.innerHTML = filtered.length === 0
                ? '<div class="dropdown-empty">No matches</div>'
                : filtered.map(function(item) { return '<div class="dropdown-item">' + item + '</div>'; }).join("");
            listEl.classList.add("open");

            listEl.querySelectorAll(".dropdown-item").forEach(function(el) {
                el.addEventListener("mousedown", function(e) {
                    e.preventDefault();
                    onSelect(el.textContent);
                    inputEl.value = el.textContent;
                    listEl.classList.remove("open");
                    clearEl.style.display = "block";
                    updateUI();
                });
            });
        }

        inputEl.addEventListener("focus", function() {
            inputEl.value = "";
            renderList("");
        });

        inputEl.addEventListener("input", function() {
            renderList(inputEl.value);
        });

        inputEl.addEventListener("blur", function() {
            setTimeout(function() {
                listEl.classList.remove("open");
                var sel = getSelected();
                if (sel) {
                    inputEl.value = sel;
                    clearEl.style.display = "block";
                } else {
                    inputEl.value = "";
                    clearEl.style.display = "none";
                }
            }, 150);
        });

        clearEl.addEventListener("click", function() {
            onSelect("");
            inputEl.value = "";
            clearEl.style.display = "none";
            updateUI();
        });
    }

    setupDropdown(
        document.getElementById("locationInput"),
        document.getElementById("locationList"),
        document.getElementById("locationClear"),
        UK_LOCATIONS,
        function(val) { selectedLocation = val; },
        function() { return selectedLocation; }
    );

    setupDropdown(
        document.getElementById("categoryInput"),
        document.getElementById("categoryList"),
        document.getElementById("categoryClear"),
        CATEGORIES,
        function(val) { selectedCategory = val; },
        function() { return selectedCategory; }
    );

    // Search via Cloudflare Worker
    async function searchWorker(query, category, limit) {
        limit = limit || RESULT_LIMIT;
        try {
            const response = await fetch(WORKER_URL, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ query: query, category: category, limit: limit })
            });
            const data = await response.json();
            if (data.error) {
                console.error("Worker error:", data.error);
                return [];
            }
            return (data.results || []).slice(0, limit);
        } catch (e) {
            console.error("Search failed:", e);
            return [];
        }
    }

    // Rendering helpers
    function escapeHtml(str) {
        var div = document.createElement('div');
        div.appendChild(document.createTextNode(str));
        return div.innerHTML;
    }

    function renderOnlineCard(r) {
        return '<a href="' + r.url + '" target="_blank" rel="noopener noreferrer" class="result-card">' +
            '<div class="result-name">' + escapeHtml(r.name) + '</div>' +
            '<div class="result-snippet">' + escapeHtml(r.snippet) + '</div>' +
            '<div class="result-url">' + escapeHtml(r.displayUrl || r.url) + '</div>' +
            '</a>';
    }

    function renderPhysicalCard(r) {
        var icon = CATEGORY_ICONS[getSearchTerm()] || "üõçÔ∏è";
        return '<a href="' + r.url + '" target="_blank" rel="noopener noreferrer" class="physical-card">' +
            '<div class="category-icon">' + icon + '</div>' +
            '<div class="card-text">' +
                '<div class="result-name">' + escapeHtml(r.name) + '</div>' +
                '<div class="card-snippet">' + escapeHtml(r.snippet) + '</div>' +
            '</div>' +
            '</a>';
    }

    function renderSectionHeader(icon, title, color, id) {
        return '<div class="section-header">' +
            '<span class="section-icon" style="background:' + color + '15;">' + icon + '</span>' +
            '<div>' +
                '<div class="section-title">' + title + '</div>' +
                '<div class="section-count" id="count-' + id + '">Searching...</div>' +
            '</div>' +
            '<div class="spinner" id="spinner-' + id + '" style="border-top-color:' + color + ';"></div>' +
        '</div>';
    }

    function updateSection(id, count) {
        var countEl = document.getElementById("count-" + id);
        var spinnerEl = document.getElementById("spinner-" + id);
        if (countEl) countEl.textContent = count + " result" + (count !== 1 ? "s" : "") + " found";
        if (spinnerEl) spinnerEl.remove();
    }

    // Physical cards now use category emoji icons (no external calls needed)

    // Main search handler
    searchBtn.addEventListener("click", async function() {
        var term = getSearchTerm();
        if (!term || !shopType) return;
        if (shopType === "physical" && !selectedLocation) return;
        if (isSearching) return;

        isSearching = true;
        updateUI();
        emptyState.style.display = "none";

        var loc = selectedLocation;
        var html = "";

        if (shopType === "physical") {
            // Physical shops only
            html += renderSectionHeader("üè™", "Shops in " + escapeHtml(loc), "#2ecc71", "local");
            html += '<div id="local-results"></div>';
            resultsDiv.innerHTML = html;

            var localResults = await searchWorker(term + " shops in " + loc + " UK", "local", RESULT_LIMIT);
            var mapped = localResults.map(function(item) {
                return {
                    name: item.name,
                    snippet: item.snippet,
                    url: "https://www.google.com/maps/search/" + encodeURIComponent(item.name + ", " + loc)
                };
            });

            updateSection("local", mapped.length);
            document.getElementById("local-results").innerHTML = mapped.length > 0
                ? mapped.map(function(r) { return renderPhysicalCard(r); }).join("")
                : '<p class="no-results">No local results found. Try a different category.</p>';

            isSearching = false;
            updateUI();

        } else {
            // Online shops: Etsy only
            html += renderSectionHeader("üåê", "Online shops", "#8e44ad", "online");
            html += '<div id="online-results"></div>';
            resultsDiv.innerHTML = html;

            searchWorker("site:etsy.com/uk/shop " + term, "etsy", RESULT_LIMIT).then(function(r) {
                var etsyResults = r
                    .map(function(item) {
                        var url = item.url;
                        var m = url.match(/etsy\.com(?:\/uk)?\/shop\/([A-Za-z0-9]+)/);
                        if (m) url = "https://www.etsy.com/uk/shop/" + m[1];
                        return { name: item.name, snippet: item.snippet, url: url };
                    })
                    .filter(function(item) { return item.url.startsWith("https://www.etsy.com/uk/shop"); })
                    .map(function(item) {
                        return { name: item.name, snippet: item.snippet, displayUrl: item.url, url: etsyAffiliateUrl(item.url) };
                    });

                updateSection("online", etsyResults.length);
                document.getElementById("online-results").innerHTML = etsyResults.length > 0
                    ? etsyResults.map(renderOnlineCard).join("")
                    : '<p class="no-results">No online results found.</p>';

                isSearching = false;
                updateUI();
            });
        }
    });

    // Init
    updateUI();
    </script>
</body>
</html>
