import { useState, useEffect, useRef } from "react";

const AMAZON_ASSOCIATE_TAG = "yoursite-21";     
const AWIN_PUBLISHER_ID = "000000";            
const AWIN_ETSY_ADVERTISER_ID = "6220";         

const amazonAffiliateUrl = (url) => {
  const separator = url.includes("?") ? "&" : "?";
  return `${url}${separator}tag=${AMAZON_ASSOCIATE_TAG}`;
};

const etsyAffiliateUrl = (url) => {
  return `https://www.awin1.com/cread.php?awinmid=${AWIN_ETSY_ADVERTISER_ID}&awinaffid=${AWIN_PUBLISHER_ID}&ued=${encodeURIComponent(url)}`;
};

const CATEGORIES = [
  "Animals & Pets","Antiques","Arts and Crafts","Bakery","Beauty & Make-up",
  "Beer, Wine & Spirits","Booksellers","Butcher","Cars & Motorbikes","Charity",
  "Cheesemonger","Chocolatier","Comics & Manga","Computers and Televisions",
  "Delicatessen","Fashion & Clothing","Fishmonger","Footwear","Gardening",
  "Greengrocer","Haberdashery (Sewing & Knitting)","Health Food","Jewellery",
  "Painting & Photography","Sports & Fitness","Sweets & Confectionary",
  "Tea and Coffee","Toys & Games","Video Games"
];

const UK_LOCATIONS = [
  "Aberdeen","Bath","Belfast","Birmingham","Blackburn","Blackpool","Bolton","Bournemouth",
  "Bradford","Brighton","Bristol","Burnley","Cambridge","Canterbury","Cardiff","Carlisle",
  "Chelmsford","Cheltenham","Chester","Colchester","Coventry","Crawley","Darlington","Derby",
  "Doncaster","Dover","Dundee","Durham","Edinburgh","Exeter","Glasgow","Gloucester",
  "Grimsby","Guildford","Halifax","Harrogate","Huddersfield","Hull","Inverness","Ipswich",
  "Keighley","Lancaster","Leeds","Leicester","Lincoln","Liverpool","London","Luton",
  "Macclesfield","Manchester","Middlesbrough","Milton Keynes","Newcastle","Northampton",
  "Norwich","Nottingham","Oldham","Oxford","Perth","Peterborough","Plymouth","Portsmouth",
  "Preston","Reading","Rochdale","Rotherham","Saltaire","Scarborough","Sheffield","Shipley",
  "Shrewsbury","Skipton","Southampton","Southend","St Albans","Stockport","Stoke-on-Trent",
  "Sunderland","Swansea","Swindon","Taunton","Wakefield","Walsall","Warrington","Wigan",
  "Winchester","Wolverhampton","Worcester","York"
];

const RESULT_LIMIT = 10;

const searchCategory = async (query, category, limit = RESULT_LIMIT) => {
  const prompts = {
    local: `Search the web for: ${query}

Return ONLY a JSON array of up to ${limit} real shops or businesses found. Each result must have "name", "url", and "snippet" fields. The "name" should be the actual business name. Example format:
[{"name":"The Pot Shop","url":"https://example.com","snippet":"Brief description of the shop"}]

Return ONLY the JSON array, no markdown, no backticks, no explanation.`,
    amazon: `Search the web for: ${query}

Return ONLY a JSON array of up to ${limit} Amazon.co.uk store/brand results. Each result must have "name", "url", and "snippet" fields. URLs MUST be Amazon UK store URLs in the format https://www.amazon.co.uk/stores/StoreName or https://www.amazon.co.uk/stores/page/ID ‚Äî do not include individual product listing URLs. Example format:
[{"name":"Store Name","url":"https://www.amazon.co.uk/stores/ExampleStore","snippet":"Brief description of the store"}]

Return ONLY the JSON array, no markdown, no backticks, no explanation.`,
    etsy: `Search the web for: ${query}

Return ONLY a JSON array of up to ${limit} Etsy UK shop results. Each result must have "name", "url", and "snippet" fields. URLs MUST be Etsy UK shop URLs in the format https://www.etsy.com/uk/shop/ShopName ‚Äî do not include product listing URLs. Example format:
[{"name":"Shop Name","url":"https://www.etsy.com/uk/shop/ExampleShop","snippet":"Brief description of the shop"}]

Return ONLY the JSON array, no markdown, no backticks, no explanation.`
  };

  try {
    const response = await fetch("https://api.anthropic.com/v1/messages", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        model: "claude-sonnet-4-20250514",
        max_tokens: 4000,
        messages: [{ role: "user", content: prompts[category] }],
        tools: [{ type: "web_search_20250305", name: "web_search" }]
      })
    });
    const data = await response.json();
    const text = data.content
      .filter(b => b.type === "text")
      .map(b => b.text)
      .join("");
    const clean = text.replace(/```json|```/g, "").trim();
    const results = JSON.parse(clean);
    return results.slice(0, limit);
  } catch (e) {
    console.error(`Search failed for ${category}:`, e);
    return [];
  }
};

// Geocode a shop using OpenStreetMap's Nominatim (free, 1 req/sec)
const geocodeShop = async (name, city) => {
  try {
    const query = encodeURIComponent(`${name}, ${city}, UK`);
    const res = await fetch(
      `https://nominatim.openstreetmap.org/search?q=${query}&format=json&limit=1`,
      { headers: { "User-Agent": "ShopFinderUK/1.0" } }
    );
    const data = await res.json();
    if (data.length > 0) {
      return { lat: parseFloat(data[0].lat), lng: parseFloat(data[0].lon) };
    }
  } catch (e) { console.error("Geocode failed:", e); }
  return null;
};

// Convert lat/lng to an OpenStreetMap tile image URL
const getTileUrl = (lat, lng, zoom = 16) => {
  const n = Math.pow(2, zoom);
  const x = Math.floor((lng + 180) / 360 * n);
  const latRad = lat * Math.PI / 180;
  const y = Math.floor((1 - Math.log(Math.tan(latRad) + 1 / Math.cos(latRad)) / Math.PI) / 2 * n);
  return `https://tile.openstreetmap.org/${zoom}/${x}/${y}.png`;
};

// Small delay helper for rate-limiting Nominatim
const delay = (ms) => new Promise(r => setTimeout(r, ms));

const PhysicalResultCard = ({ name, url, snippet, coords }) => (
  <a href={url} target="_blank" rel="noopener noreferrer" style={{
    display: "flex", gap: 12, background: "#fff", borderRadius: 8,
    padding: "10px 12px", textDecoration: "none", color: "#1a1a2e",
    border: "1px solid #eee", transition: "all 0.15s", alignItems: "center",
  }}
    onMouseEnter={e => {
      e.currentTarget.style.boxShadow = "0 3px 12px rgba(0,0,0,0.07)";
      e.currentTarget.style.borderColor = "#d0c9be";
    }}
    onMouseLeave={e => {
      e.currentTarget.style.boxShadow = "none";
      e.currentTarget.style.borderColor = "#eee";
    }}
  >
    {coords ? (
      <img
        src={getTileUrl(coords.lat, coords.lng)}
        alt={`Map near ${name}`}
        style={{
          width: 72, height: 72, borderRadius: 6, objectFit: "cover",
          flexShrink: 0, background: "#f0ece4"
        }}
      />
    ) : (
      <div style={{
        width: 72, height: 72, borderRadius: 6, background: "#f0ece4",
        flexShrink: 0, display: "flex", alignItems: "center", justifyContent: "center"
      }}>
        <span style={{ fontSize: 22, opacity: 0.4 }}>üìç</span>
      </div>
    )}
    <div style={{ minWidth: 0, flex: 1 }}>
      <div style={{ fontWeight: 600, fontSize: 14, marginBottom: 2, lineHeight: 1.3 }}>{name}</div>
      <div style={{
        fontSize: 12, color: "#888", lineHeight: 1.4,
        overflow: "hidden", textOverflow: "ellipsis",
        display: "-webkit-box", WebkitLineClamp: 2, WebkitBoxOrient: "vertical"
      }}>{snippet}</div>
    </div>
  </a>
);

const ResultCard = ({ name, url, snippet }) => (
  <a href={url} target="_blank" rel="noopener noreferrer" style={{
    display: "block", background: "#fff", borderRadius: 8,
    padding: "12px 16px", textDecoration: "none", color: "#1a1a2e",
    border: "1px solid #eee", transition: "all 0.15s",
  }}
    onMouseEnter={e => {
      e.currentTarget.style.boxShadow = "0 3px 12px rgba(0,0,0,0.07)";
      e.currentTarget.style.borderColor = "#d0c9be";
    }}
    onMouseLeave={e => {
      e.currentTarget.style.boxShadow = "none";
      e.currentTarget.style.borderColor = "#eee";
    }}
  >
    <div style={{ fontWeight: 600, fontSize: 14, marginBottom: 3, lineHeight: 1.3 }}>{name}</div>
    <div style={{ fontSize: 12, color: "#888", lineHeight: 1.4 }}>{snippet}</div>
    <div style={{
      fontSize: 11, color: "#b0a890", marginTop: 4, overflow: "hidden",
      textOverflow: "ellipsis", whiteSpace: "nowrap"
    }}>{url}</div>
  </a>
);

const SectionHeader = ({ icon, title, color, count, loading }) => (
  <div style={{
    display: "flex", alignItems: "center", gap: 10, marginBottom: 10, marginTop: 24
  }}>
    <span style={{
      fontSize: 20, width: 36, height: 36, display: "flex",
      alignItems: "center", justifyContent: "center",
      background: `${color}15`, borderRadius: 8
    }}>{icon}</span>
    <div>
      <div style={{ fontWeight: 700, fontSize: 15, color: "#1a1a2e" }}>{title}</div>
      <div style={{ fontSize: 12, color: "#aaa" }}>
        {loading ? "Searching..." : `${count} result${count !== 1 ? "s" : ""} found`}
      </div>
    </div>
    {loading && (
      <div style={{
        marginLeft: "auto", width: 18, height: 18,
        border: "2px solid #e0dbd2", borderTopColor: color,
        borderRadius: "50%",
        animation: "spin 0.8s linear infinite"
      }} />
    )}
  </div>
);

export default function ShopFinder() {
  const [location, setLocation] = useState("");
  const [filterText, setFilterText] = useState("");
  const [showDropdown, setShowDropdown] = useState(false);
  const [keywords, setKeywords] = useState("");
  const [categoryFilter, setCategoryFilter] = useState("");
  const [showCategoryDropdown, setShowCategoryDropdown] = useState(false);
  const [searchMode, setSearchMode] = useState("category"); // "category" or "name"
  const [shopName, setShopName] = useState("");
  const [shopType, setShopType] = useState(""); // "physical" or "online"
  const [localResults, setLocalResults] = useState(null);
  const [amazonResults, setAmazonResults] = useState(null);
  const [etsyResults, setEtsyResults] = useState(null);
  const [loadingLocal, setLoadingLocal] = useState(false);
  const [loadingAmazon, setLoadingAmazon] = useState(false);
  const [loadingEtsy, setLoadingEtsy] = useState(false);
  const [hasSearched, setHasSearched] = useState(false);
  const dropdownRef = useRef(null);
  const categoryRef = useRef(null);

  const filteredCategories = CATEGORIES.filter(c =>
    c.toLowerCase().includes(categoryFilter.toLowerCase())
  );

  const filtered = UK_LOCATIONS.filter(l =>
    l.toLowerCase().includes(filterText.toLowerCase())
  );

  useEffect(() => {
    const handler = (e) => {
      if (dropdownRef.current && !dropdownRef.current.contains(e.target)) {
        setShowDropdown(false);
      }
      if (categoryRef.current && !categoryRef.current.contains(e.target)) {
        setShowCategoryDropdown(false);
      }
    };
    document.addEventListener("mousedown", handler);
    return () => document.removeEventListener("mousedown", handler);
  }, []);

  const isLoading = loadingLocal || loadingAmazon || loadingEtsy;

  const searchTerm = searchMode === "category" ? keywords.trim() : shopName.trim();

  const handleSearch = async () => {
    if (!searchTerm || !shopType) return;
    if (shopType === "physical" && !location) return;

    const q = searchTerm;
    const loc = location;

    setHasSearched(true);
    setLocalResults(null);
    setAmazonResults(null);
    setEtsyResults(null);

    if (shopType === "physical") {
      // Local shops only
      setLoadingLocal(true);
      searchCategory(`${q} shops in ${loc} UK`, "local").then(async r => {
        const mapped = r.map(item => ({
          ...item,
          coords: null,
          url: `https://www.google.com/maps/search/${encodeURIComponent(item.name + ", " + loc)}`
        }));
        setLocalResults(mapped);
        setLoadingLocal(false);

        // Geocode each result in background (Nominatim: 1 req/sec)
        for (let i = 0; i < mapped.length; i++) {
          const coords = await geocodeShop(mapped[i].name, loc);
          if (coords) {
            setLocalResults(prev => prev ? prev.map((item, idx) =>
              idx === i ? { ...item, coords } : item
            ) : prev);
          }
          if (i < mapped.length - 1) await delay(1100);
        }
      });
    } else {
      // Online shops: Amazon (5) + Etsy (5) = 10 total
      setLoadingAmazon(true);
      searchCategory(`site:amazon.co.uk/stores ${q}`, "amazon", Math.floor(RESULT_LIMIT / 2)).then(r => {
        const filtered = r
          .map(item => {
            let url = item.url;
            if (!url.startsWith("https://www.amazon.co.uk/stores")) {
              const storeMatch = url.match(/amazon\.co\.uk\/stores\/([\w\-\/]+)/);
              if (storeMatch) {
                url = `https://www.amazon.co.uk/stores/${storeMatch[1]}`;
              }
            }
            return { ...item, url };
          })
          .filter(item => item.url.startsWith("https://www.amazon.co.uk/stores"))
          .map(item => ({ ...item, url: amazonAffiliateUrl(item.url) }));
        setAmazonResults(filtered);
        setLoadingAmazon(false);
      });

      setLoadingEtsy(true);
      searchCategory(`site:etsy.com/uk/shop ${q}`, "etsy", Math.ceil(RESULT_LIMIT / 2)).then(r => {
        const filtered = r
          .map(item => {
            let url = item.url;
            const shopMatch = url.match(/etsy\.com(?:\/uk)?\/shop\/([A-Za-z0-9]+)/);
            if (shopMatch) {
              url = `https://www.etsy.com/uk/shop/${shopMatch[1]}`;
            }
            return { ...item, url };
          })
          .filter(item => item.url.startsWith("https://www.etsy.com/uk/shop"))
          .map(item => ({ ...item, url: etsyAffiliateUrl(item.url) }));
        setEtsyResults(filtered);
        setLoadingEtsy(false);
      });
    }
  };

  const canSearch = searchTerm && shopType && (shopType === "online" || location);

  return (
    <div style={{
      minHeight: "100vh",
      background: "linear-gradient(160deg, #faf8f4 0%, #f0ece4 100%)",
      fontFamily: "'DM Sans', sans-serif"
    }}>
      <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet" />
      <style>{`@keyframes spin { to { transform: rotate(360deg); } }`}</style>

      {/* Header */}
      <div style={{
        background: "#1a1a2e", padding: "40px 20px 36px", textAlign: "center",
        borderBottom: "3px solid #c9a96e"
      }}>
        <div style={{ fontSize: 36, marginBottom: 8 }}>üõçÔ∏è</div>
        <h1 style={{
          fontFamily: "'Playfair Display', serif", fontSize: 30,
          color: "#e8d5b7", margin: "0 0 6px", letterSpacing: "-0.5px"
        }}>ShopFinder UK</h1>
        <p style={{ color: "rgba(232,213,183,0.5)", fontSize: 14, margin: 0 }}>
          Discover independent shops across the UK
        </p>
      </div>

      {/* Search Area */}
      <div style={{ maxWidth: 600, margin: "0 auto", padding: "28px 20px" }}>

        {/* Shop Type Toggle */}
        <div style={{ marginBottom: 16 }}>
          <label style={{
            fontSize: 11, fontWeight: 700, color: "#999",
            textTransform: "uppercase", letterSpacing: "0.5px",
            display: "block", marginBottom: 8
          }}>Search for</label>
          <div style={{ display: "flex", gap: 8 }}>
            {[
              { value: "physical", label: "üè™ Physical Shops", sublabel: "Local high street" },
              { value: "online", label: "üåê Online Shops", sublabel: "Amazon & Etsy" }
            ].map(opt => (
              <button
                key={opt.value}
                onClick={() => setShopType(opt.value)}
                style={{
                  flex: 1, padding: "14px 12px", borderRadius: 10,
                  border: shopType === opt.value ? "2px solid #1a1a2e" : "2px solid #e0dbd2",
                  background: shopType === opt.value ? "#1a1a2e" : "#fff",
                  color: shopType === opt.value ? "#e8d5b7" : "#555",
                  cursor: "pointer", textAlign: "center",
                  transition: "all 0.15s"
                }}
              >
                <div style={{ fontSize: 15, fontWeight: 600 }}>{opt.label}</div>
                <div style={{
                  fontSize: 11, marginTop: 2,
                  color: shopType === opt.value ? "rgba(232,213,183,0.6)" : "#aaa"
                }}>{opt.sublabel}</div>
              </button>
            ))}
          </div>
        </div>

        {/* Location (only show for physical shops) */}
        {shopType === "physical" && (
          <div ref={dropdownRef} style={{ position: "relative", marginBottom: 12 }}>
            <label style={{
              fontSize: 11, fontWeight: 700, color: "#999",
              textTransform: "uppercase", letterSpacing: "0.5px",
              display: "block", marginBottom: 6
            }}>Your location</label>
            <div style={{ position: "relative" }}>
              <input
                type="text"
                placeholder="Select a town or city..."
                value={showDropdown ? filterText : location}
                onChange={e => { setFilterText(e.target.value); setShowDropdown(true); }}
                onFocus={() => { setShowDropdown(true); setFilterText(""); }}
                style={{
                  width: "100%", padding: "13px 40px 13px 16px", borderRadius: 10,
                  border: "2px solid #e0dbd2", fontSize: 15, outline: "none",
                  boxSizing: "border-box", background: "#fff"
                }}
              />
              {location && !showDropdown && (
                <span onClick={() => { setLocation(""); setFilterText(""); }}
                  style={{
                    position: "absolute", right: 14, top: "50%", transform: "translateY(-50%)",
                    cursor: "pointer", color: "#bbb", fontSize: 18, lineHeight: 1
                  }}>√ó</span>
              )}
            </div>
            {showDropdown && (
              <div style={{
                position: "absolute", top: "100%", left: 0, right: 0, zIndex: 50,
                background: "#fff", borderRadius: "0 0 10px 10px",
                boxShadow: "0 8px 24px rgba(0,0,0,0.1)", maxHeight: 220,
                overflowY: "auto", border: "1px solid #e0dbd2", borderTop: "none"
              }}>
                {filtered.length === 0 ? (
                  <div style={{ padding: "12px 16px", color: "#aaa", fontSize: 13 }}>No matches</div>
                ) : filtered.map(loc => (
                  <div key={loc}
                    onClick={() => { setLocation(loc); setFilterText(""); setShowDropdown(false); }}
                    style={{ padding: "10px 16px", cursor: "pointer", fontSize: 14, color: "#333" }}
                    onMouseEnter={e => e.currentTarget.style.background = "#faf6ee"}
                    onMouseLeave={e => e.currentTarget.style.background = "#fff"}
                  >{loc}</div>
                ))}
              </div>
            )}
          </div>
        )}

        {/* Search By Toggle */}
        <div style={{ marginBottom: 12 }}>
          <label style={{
            fontSize: 11, fontWeight: 700, color: "#999",
            textTransform: "uppercase", letterSpacing: "0.5px",
            display: "block", marginBottom: 8
          }}>Search by</label>
          <div style={{ display: "flex", gap: 6 }}>
            {[
              { value: "category", label: "Category" },
              { value: "name", label: "Shop name" }
            ].map(opt => (
              <button
                key={opt.value}
                onClick={() => setSearchMode(opt.value)}
                style={{
                  flex: 1, padding: "9px 12px", borderRadius: 8,
                  border: searchMode === opt.value ? "2px solid #1a1a2e" : "2px solid #e0dbd2",
                  background: searchMode === opt.value ? "#1a1a2e" : "#fff",
                  color: searchMode === opt.value ? "#e8d5b7" : "#555",
                  cursor: "pointer", fontSize: 13, fontWeight: 600,
                  transition: "all 0.15s"
                }}
              >{opt.label}</button>
            ))}
          </div>
        </div>

        {/* Category dropdown (when searchMode is "category") */}
        {searchMode === "category" && (
          <div ref={categoryRef} style={{ position: "relative", marginBottom: 12 }}>
            <label style={{
              fontSize: 11, fontWeight: 700, color: "#999",
              textTransform: "uppercase", letterSpacing: "0.5px",
              display: "block", marginBottom: 6
            }}>What are you looking for?</label>
            <div style={{ position: "relative" }}>
              <input
                type="text"
                placeholder="Select a category..."
                value={showCategoryDropdown ? categoryFilter : keywords}
                onChange={e => { setCategoryFilter(e.target.value); setShowCategoryDropdown(true); }}
                onFocus={() => { setShowCategoryDropdown(true); setCategoryFilter(""); }}
                style={{
                  width: "100%", padding: "13px 40px 13px 16px", borderRadius: 10,
                  border: "2px solid #e0dbd2", fontSize: 15, outline: "none",
                  boxSizing: "border-box", background: "#fff"
                }}
              />
              {keywords && !showCategoryDropdown && (
                <span onClick={() => { setKeywords(""); setCategoryFilter(""); }}
                  style={{
                    position: "absolute", right: 14, top: "50%", transform: "translateY(-50%)",
                    cursor: "pointer", color: "#bbb", fontSize: 18, lineHeight: 1
                  }}>√ó</span>
              )}
            </div>
            {showCategoryDropdown && (
              <div style={{
                position: "absolute", top: "100%", left: 0, right: 0, zIndex: 50,
                background: "#fff", borderRadius: "0 0 10px 10px",
                boxShadow: "0 8px 24px rgba(0,0,0,0.1)", maxHeight: 220,
                overflowY: "auto", border: "1px solid #e0dbd2", borderTop: "none"
              }}>
                {filteredCategories.length === 0 ? (
                  <div style={{ padding: "12px 16px", color: "#aaa", fontSize: 13 }}>No matches</div>
                ) : filteredCategories.map(cat => (
                  <div key={cat}
                    onClick={() => { setKeywords(cat); setCategoryFilter(""); setShowCategoryDropdown(false); }}
                    style={{ padding: "10px 16px", cursor: "pointer", fontSize: 14, color: "#333" }}
                    onMouseEnter={e => e.currentTarget.style.background = "#faf6ee"}
                    onMouseLeave={e => e.currentTarget.style.background = "#fff"}
                  >{cat}</div>
                ))}
              </div>
            )}
          </div>
        )}

        {/* Shop name text box (when searchMode is "name") */}
        {searchMode === "name" && (
          <div style={{ marginBottom: 12 }}>
            <label style={{
              fontSize: 11, fontWeight: 700, color: "#999",
              textTransform: "uppercase", letterSpacing: "0.5px",
              display: "block", marginBottom: 6
            }}>Shop name</label>
            <div style={{ position: "relative" }}>
              <input
                type="text"
                placeholder="e.g. The Chocolate Factory, Bob's Books..."
                value={shopName}
                onChange={e => setShopName(e.target.value)}
                style={{
                  width: "100%", padding: "13px 40px 13px 16px", borderRadius: 10,
                  border: "2px solid #e0dbd2", fontSize: 15, outline: "none",
                  boxSizing: "border-box", background: "#fff"
                }}
              />
              {shopName && (
                <span onClick={() => setShopName("")}
                  style={{
                    position: "absolute", right: 14, top: "50%", transform: "translateY(-50%)",
                    cursor: "pointer", color: "#bbb", fontSize: 18, lineHeight: 1
                  }}>√ó</span>
              )}
            </div>
          </div>
        )}

        <button onClick={handleSearch}
          disabled={isLoading || !canSearch}
          style={{
            width: "100%", padding: "13px 28px", borderRadius: 10, border: "none",
            background: "#1a1a2e", color: "#e8d5b7", fontSize: 15,
            fontWeight: 700, cursor: canSearch && !isLoading ? "pointer" : "default",
            marginBottom: 8,
            opacity: (!canSearch || isLoading) ? 0.4 : 1
          }}>
          {isLoading ? "Searching..." : "Search"}
        </button>

        {/* Validation hint */}
        {!shopType && (
          <p style={{ fontSize: 12, color: "#c9a96e", textAlign: "center", margin: "4px 0 0" }}>
            Choose Physical or Online shops above to get started
          </p>
        )}
        {shopType === "physical" && !location && searchTerm && (
          <p style={{ fontSize: 12, color: "#c9a96e", textAlign: "center", margin: "4px 0 0" }}>
            Select a location to search for physical shops
          </p>
        )}

        {/* Results */}
        {hasSearched && (
          <div style={{ marginTop: 16 }}>
            {/* Physical Shop Results */}
            {shopType === "physical" && (
              <>
                <SectionHeader
                  icon="üè™" title={`Shops in ${location}`} color="#2ecc71"
                  count={localResults?.length || 0} loading={loadingLocal}
                />
                {localResults && localResults.length > 0 && (
                  <div style={{ display: "flex", flexDirection: "column", gap: 6 }}>
                    {localResults.map((r, i) => (
                      <PhysicalResultCard key={`local-${i}`} {...r} />
                    ))}
                  </div>
                )}
                {localResults && localResults.length === 0 && (
                  <p style={{ color: "#bbb", fontSize: 13, margin: "4px 0 0", padding: "8px 0" }}>
                    No local results found. Try a different category.
                  </p>
                )}
              </>
            )}

            {/* Online Shop Results */}
            {shopType === "online" && (
              <>
                <SectionHeader
                  icon="üåê" title="Online shops" color="#8e44ad"
                  count={(amazonResults?.length || 0) + (etsyResults?.length || 0)}
                  loading={loadingAmazon || loadingEtsy}
                />
                {(() => {
                  const amz = (amazonResults || []).map((r, i) => ({ ...r, _key: `amz-${i}` }));
                  const ets = (etsyResults || []).map((r, i) => ({ ...r, _key: `etsy-${i}` }));
                  const interleaved = [];
                  const max = Math.max(amz.length, ets.length);
                  for (let i = 0; i < max; i++) {
                    if (i < amz.length) interleaved.push(amz[i]);
                    if (i < ets.length) interleaved.push(ets[i]);
                  }
                  return interleaved.length > 0 ? (
                    <div style={{ display: "flex", flexDirection: "column", gap: 6 }}>
                      {interleaved.map(r => <ResultCard key={r._key} {...r} />)}
                    </div>
                  ) : (amazonResults && etsyResults) ? (
                    <p style={{ color: "#bbb", fontSize: 13, margin: "4px 0 0", padding: "8px 0" }}>
                      No online results found.
                    </p>
                  ) : null;
                })()}
              </>
            )}
          </div>
        )}

        {!hasSearched && (
          <div style={{ textAlign: "center", padding: "40px 20px" }}>
            <div style={{ fontSize: 40, marginBottom: 12 }}>üîç</div>
            <p style={{ margin: 0, fontSize: 14, color: "#bbb" }}>
              Choose a shop type and category to start searching
            </p>
          </div>
        )}

        <p style={{
          fontSize: 11, color: "#bbb", textAlign: "center",
          marginTop: 32, padding: "12px 0", borderTop: "1px solid #e8e2d8"
        }}>
          As an Amazon Associate and Etsy Affiliate, we earn from qualifying purchases.
          <br />Map data ¬© <a href="https://www.openstreetmap.org/copyright" target="_blank" rel="noopener noreferrer" style={{ color: "#bbb" }}>OpenStreetMap</a> contributors.
        </p>
      </div>
    </div>
  );
}
