<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ShopFinder UK</title>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'DM Sans', sans-serif; background: linear-gradient(160deg, #faf8f4 0%, #f0ece4 100%); min-height: 100vh; }
        @keyframes spin { to { transform: rotate(360deg); } }

        .header { background: #1a1a2e; padding: 40px 20px 36px; text-align: center; border-bottom: 3px solid #c9a96e; }
        .header h1 { font-family: 'Playfair Display', serif; font-size: 30px; color: #e8d5b7; margin: 0 0 6px; letter-spacing: -0.5px; }
        .header p { color: rgba(232,213,183,0.5); font-size: 14px; }
        .container { max-width: 600px; margin: 0 auto; padding: 28px 20px; }
        .field-label { font-size: 11px; font-weight: 700; color: #999; text-transform: uppercase; letter-spacing: 0.5px; display: block; margin-bottom: 6px; }
        .field-label-mb8 { margin-bottom: 8px; }

        .saved-btn { width: 100%; padding: 12px 16px; border-radius: 10px; border: 2px solid #e0dbd2; background: #fff; color: #1a1a2e; cursor: pointer; margin-bottom: 16px; display: flex; align-items: center; justify-content: center; gap: 8px; font-size: 14px; font-weight: 600; transition: all 0.15s; font-family: 'DM Sans', sans-serif; }
        .saved-btn.active { border-color: #c9a96e; background: #faf6ee; }
        .saved-btn .badge { background: #1a1a2e; color: #e8d5b7; font-size: 11px; font-weight: 700; padding: 2px 8px; border-radius: 10px; margin-left: 4px; }

        .toggle-row { display: flex; gap: 8px; margin-bottom: 16px; }
        .toggle-btn { flex: 1; padding: 14px 12px; border-radius: 10px; border: 2px solid #e0dbd2; background: #fff; color: #555; cursor: pointer; text-align: center; transition: all 0.15s; font-family: 'DM Sans', sans-serif; }
        .toggle-btn.active { border-color: #1a1a2e; background: #1a1a2e; color: #e8d5b7; }
        .toggle-btn .label { font-size: 15px; font-weight: 600; }
        .toggle-btn .sublabel { font-size: 11px; margin-top: 2px; color: #aaa; }
        .toggle-btn.active .sublabel { color: rgba(232,213,183,0.6); }

        .toggle-row-sm { display: flex; gap: 6px; margin-bottom: 12px; }
        .toggle-btn-sm { flex: 1; padding: 9px 12px; border-radius: 8px; border: 2px solid #e0dbd2; background: #fff; color: #555; cursor: pointer; font-size: 13px; font-weight: 600; transition: all 0.15s; font-family: 'DM Sans', sans-serif; }
        .toggle-btn-sm.active { border-color: #1a1a2e; background: #1a1a2e; color: #e8d5b7; }

        .dropdown-wrapper { position: relative; margin-bottom: 12px; }
        .dropdown-input { width: 100%; padding: 13px 40px 13px 16px; border-radius: 10px; border: 2px solid #e0dbd2; font-size: 15px; outline: none; background: #fff; font-family: 'DM Sans', sans-serif; }
        .dropdown-clear { position: absolute; right: 14px; top: 50%; transform: translateY(-50%); cursor: pointer; color: #bbb; font-size: 18px; line-height: 1; background: none; border: none; display: none; }
        .dropdown-list { position: absolute; top: 100%; left: 0; right: 0; z-index: 50; background: #fff; border-radius: 0 0 10px 10px; box-shadow: 0 8px 24px rgba(0,0,0,0.1); max-height: 220px; overflow-y: auto; border: 1px solid #e0dbd2; border-top: none; display: none; }
        .dropdown-list.open { display: block; }
        .dropdown-item { padding: 10px 16px; cursor: pointer; font-size: 14px; color: #333; }
        .dropdown-item:hover { background: #faf6ee; }
        .dropdown-empty { padding: 12px 16px; color: #aaa; font-size: 13px; }

        .text-input-wrapper { margin-bottom: 12px; }
        .text-input { width: 100%; padding: 13px 40px 13px 16px; border-radius: 10px; border: 2px solid #e0dbd2; font-size: 15px; outline: none; background: #fff; font-family: 'DM Sans', sans-serif; }
        .text-clear { position: absolute; right: 14px; top: 50%; transform: translateY(-50%); cursor: pointer; color: #bbb; font-size: 18px; line-height: 1; background: none; border: none; }

        .search-btn { width: 100%; padding: 13px 28px; border-radius: 10px; border: none; background: #1a1a2e; color: #e8d5b7; font-size: 15px; font-weight: 700; cursor: pointer; margin-bottom: 8px; font-family: 'DM Sans', sans-serif; }
        .search-btn:disabled { opacity: 0.4; cursor: not-allowed; }
        .hint { font-size: 12px; color: #c9a96e; text-align: center; margin: 4px 0 0; }

        .section-header { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; margin-top: 24px; }
        .section-icon { font-size: 20px; width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; border-radius: 8px; }
        .section-title { font-weight: 700; font-size: 15px; color: #1a1a2e; }
        .section-count { font-size: 12px; color: #aaa; }
        .spinner { margin-left: auto; width: 18px; height: 18px; border: 2px solid #e0dbd2; border-radius: 50%; animation: spin 0.8s linear infinite; }

        .result-card { display: flex; gap: 12px; background: #fff; border-radius: 8px; padding: 10px 12px; color: #1a1a2e; border: 1px solid #eee; transition: all 0.15s; margin-bottom: 6px; align-items: center; }
        .result-card:hover { box-shadow: 0 3px 12px rgba(0,0,0,0.07); border-color: #d0c9be; }
        .result-card a { text-decoration: none; color: #1a1a2e; min-width: 0; flex: 1; }
        .result-name { font-weight: 600; font-size: 14px; margin-bottom: 2px; line-height: 1.3; }
        .result-snippet { font-size: 12px; color: #888; line-height: 1.4; overflow: hidden; text-overflow: ellipsis; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; }
        .result-url { font-size: 11px; color: #b0a890; margin-top: 4px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .category-icon { width: 56px; height: 56px; border-radius: 8px; background: #f8f5ef; flex-shrink: 0; display: flex; align-items: center; justify-content: center; font-size: 28px; }

        .save-btn { flex-shrink: 0; width: 36px; height: 36px; border-radius: 8px; border: none; cursor: pointer; font-size: 16px; display: flex; align-items: center; justify-content: center; transition: all 0.15s; }
        .save-btn.unsaved { background: #f8f5ef; color: #999; }
        .save-btn.saved { background: #1a1a2e; color: #e8d5b7; }

        .clear-all-btn { background: none; border: 1px solid #e0dbd2; border-radius: 6px; padding: 4px 10px; font-size: 11px; color: #999; cursor: pointer; font-family: 'DM Sans', sans-serif; }
        .clear-all-btn:hover { border-color: #ccc; color: #666; }

        .saved-empty { text-align: center; padding: 24px 16px; background: #fff; border-radius: 8px; border: 1px solid #eee; }
        .saved-empty p { font-size: 13px; color: #aaa; margin: 0; }

        .empty-state { text-align: center; padding: 40px 20px; }
        .empty-state .icon { font-size: 40px; margin-bottom: 12px; }
        .empty-state p { font-size: 14px; color: #bbb; }
        .no-results { color: #bbb; font-size: 13px; margin: 4px 0 0; padding: 8px 0; }
        .disclosure { font-size: 11px; color: #bbb; text-align: center; margin-top: 32px; padding: 12px 0; border-top: 1px solid #e8e2d8; }
        .hidden { display: none !important; }
    </style>
</head>
<body>
    <div class="header">
        <div style="font-size: 36px; margin-bottom: 8px;">üõçÔ∏è</div>
        <h1>ShopFinder UK</h1>
        <p>Discover independent shops across the UK</p>
    </div>

    <div class="container">
        <button class="saved-btn" id="savedBtn">
            <span style="font-size:18px;">‚òÖ</span>
            My Saved Places
            <span class="badge hidden" id="savedBadge">0</span>
        </button>

        <div class="hidden" id="savedPanel">
            <div class="section-header">
                <span class="section-icon" style="background:#c9a96e15;">‚òÖ</span>
                <div style="flex:1;">
                    <div class="section-title">My Saved Places</div>
                    <div class="section-count" id="savedCount">0 results found</div>
                </div>
                <button class="clear-all-btn hidden" id="clearAllBtn">Clear all</button>
            </div>
            <div id="savedList"></div>
        </div>

        <div id="searchPanel">
            <div>
                <label class="field-label field-label-mb8">Search for</label>
                <div class="toggle-row">
                    <button class="toggle-btn" id="btnPhysical" data-type="physical">
                        <div class="label">üè™ Shops in your city</div>
                        <div class="sublabel">Experiences close by</div>
                    </button>
                    <button class="toggle-btn" id="btnOnline" data-type="online">
                        <div class="label">üåê Online shops in the UK</div>
                        <div class="sublabel">Low shipping costs</div>
                    </button>
                </div>
            </div>

            <div class="dropdown-wrapper hidden" id="locationWrapper">
                <label class="field-label">Your location</label>
                <div style="position:relative;">
                    <input type="text" class="dropdown-input" id="locationInput" placeholder="Select a town or city..." autocomplete="off" />
                    <button class="dropdown-clear" id="locationClear">√ó</button>
                </div>
                <div class="dropdown-list" id="locationList"></div>
            </div>

            <div class="hidden" id="searchModeWrapper">
                <label class="field-label field-label-mb8">Search by</label>
                <div class="toggle-row-sm">
                    <button class="toggle-btn-sm active" id="btnCategory">Category</button>
                    <button class="toggle-btn-sm" id="btnName">Shop name</button>
                </div>
            </div>

            <div class="dropdown-wrapper hidden" id="categoryWrapper">
                <label class="field-label">What are you looking for?</label>
                <div style="position:relative;">
                    <input type="text" class="dropdown-input" id="categoryInput" placeholder="Select a category..." autocomplete="off" />
                    <button class="dropdown-clear" id="categoryClear">√ó</button>
                </div>
                <div class="dropdown-list" id="categoryList"></div>
            </div>

            <div class="text-input-wrapper hidden" id="nameWrapper">
                <label class="field-label">Shop name</label>
                <div style="position:relative;">
                    <input type="text" class="text-input" id="nameInput" placeholder="e.g. The Chocolate Factory, Bob's Books..." />
                    <button class="text-clear" id="nameClear" style="display:none;">√ó</button>
                </div>
            </div>

            <button class="search-btn" id="searchBtn" disabled>Search</button>
            <div id="hintArea"></div>
            <div id="resultsDiv"></div>
            <div class="empty-state" id="emptyState">
                <div class="icon">üîç</div>
                <p>Choose a shop type and category to start searching</p>
            </div>
        </div>

        <p class="disclosure">As an Etsy Affiliate, we earn from qualifying purchases.</p>
    </div>

    <script>
    // ========================================
    // SETTINGS
    // ========================================
    var GOOGLE_PLACES_API_KEY = "AIzaSyCsm5h-xdvVbeuYRIY3YEUoJiQIs3VDYdA";
    var GOOGLE_SEARCH_API_KEY = "AIzaSyCsm5h-xdvVbeuYRIY3YEUoJiQIs3VDYdA";
    var GOOGLE_SEARCH_CX = "f6dcc7150aad04289";
    var AWIN_PUBLISHER_ID = "000000";
    var AWIN_ETSY_ADVERTISER_ID = "6220";
    var RESULT_LIMIT = 10;
    var STORAGE_KEY = "shopfinder_saved";

    function etsyAffiliateUrl(url) {
        return "https://www.awin1.com/cread.php?awinmid=" + AWIN_ETSY_ADVERTISER_ID + "&awinaffid=" + AWIN_PUBLISHER_ID + "&ued=" + encodeURIComponent(url);
    }

    var CATEGORY_ICONS = {
        "Animals & Pets":"üêæ","Antiques":"üè∫","Arts and Crafts":"üé®",
        "Bakery":"üçû","Beauty & Make-up":"üíÑ","Beer, Wine & Spirits":"üç∑",
        "Booksellers":"üìö","Cars & Motorbikes":"üöó",
        "Charity":"üíõ","Chocolatier":"üç´",
        "Comics & Manga":"üí¨","Computers and Televisions":"üíª",
        "Delicatessen":"ü•ñ","Fashion & Clothing":"üëó",
        "Footwear":"üëü","Gardening":"üå±",
        "Haberdashery (Sewing & Knitting)":"üßµ",
        "Jewellery":"üíé","Meat, Fish & Cheeses":"ü•©",
        "Painting & Photography":"üñºÔ∏è",
        "Sports & Fitness":"‚öΩ","Sweets & Confectionary":"üç¨",
        "Tea and Coffee":"‚òï","Toys & Games":"üß∏","Video Games":"üéÆ"
    };
    var CATEGORIES = Object.keys(CATEGORY_ICONS);
    var UK_LOCATIONS = [
        "Aberdeen","Bath","Belfast","Birmingham","Blackburn","Blackpool","Bolton","Bournemouth",
        "Bradford","Brighton","Bristol","Burnley","Cambridge","Canterbury","Cardiff","Carlisle",
        "Chelmsford","Cheltenham","Chester","Colchester","Coventry","Crawley","Darlington","Derby",
        "Doncaster","Dover","Dundee","Durham","Edinburgh","Exeter","Glasgow","Gloucester",
        "Grimsby","Guildford","Halifax","Harrogate","Huddersfield","Hull","Inverness","Ipswich",
        "Keighley","Lancaster","Leeds","Leicester","Lincoln","Liverpool","London","Luton",
        "Macclesfield","Manchester","Middlesbrough","Milton Keynes","Newcastle","Northampton",
        "Norwich","Nottingham","Oldham","Oxford","Perth","Peterborough","Plymouth","Portsmouth",
        "Preston","Reading","Rochdale","Rotherham","Saltaire","Scarborough","Sheffield","Shipley",
        "Shrewsbury","Skipton","Southampton","Southend","St Albans","Stockport","Stoke-on-Trent",
        "Sunderland","Swansea","Swindon","Taunton","Wakefield","Walsall","Warrington","Wigan",
        "Winchester","Wolverhampton","Worcester","York"
    ];

    // ========== Saved places ==========
    function loadSaved() {
        try { return JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]"); }
        catch(e) { return []; }
    }
    function persistSaved() { localStorage.setItem(STORAGE_KEY, JSON.stringify(savedPlaces)); }
    function isSavedItem(item) { return savedPlaces.some(function(s) { return s.name === item.name && s.url === item.url; }); }
    function addSaved(item) {
        if (!isSavedItem(item)) {
            savedPlaces.push({ name: item.name, url: item.url, snippet: item.snippet, icon: item.icon || null, savedAt: Date.now() });
            persistSaved(); refreshSavedUI(); refreshResultSaveButtons();
        }
    }
    function removeSaved(item) {
        savedPlaces = savedPlaces.filter(function(s) { return !(s.name === item.name && s.url === item.url); });
        persistSaved(); refreshSavedUI(); refreshResultSaveButtons();
    }
    var savedPlaces = loadSaved();

    // ========== State ==========
    var shopType = "";
    var searchMode = "category";
    var selectedLocation = "";
    var selectedCategory = "";
    var isSearching = false;
    var showingSaved = false;
    var currentResults = [];

    // ========== DOM refs ==========
    var searchBtn = document.getElementById("searchBtn");
    var resultsDiv = document.getElementById("resultsDiv");
    var emptyState = document.getElementById("emptyState");
    var hintArea = document.getElementById("hintArea");
    var nameInput = document.getElementById("nameInput");
    var nameClear = document.getElementById("nameClear");
    var savedBtn = document.getElementById("savedBtn");
    var savedBadge = document.getElementById("savedBadge");
    var savedPanel = document.getElementById("savedPanel");
    var savedList = document.getElementById("savedList");
    var savedCount = document.getElementById("savedCount");
    var clearAllBtn = document.getElementById("clearAllBtn");
    var searchPanel = document.getElementById("searchPanel");

    function escapeHtml(str) {
        var div = document.createElement('div');
        div.appendChild(document.createTextNode(str || ""));
        return div.innerHTML;
    }

    function getSearchTerm() {
        return searchMode === "category" ? selectedCategory : (nameInput.value || "").trim();
    }

    // ========== Saved UI ==========
    function refreshSavedUI() {
        if (savedPlaces.length > 0) {
            savedBadge.textContent = savedPlaces.length;
            savedBadge.classList.remove("hidden");
        } else {
            savedBadge.classList.add("hidden");
        }
        savedBtn.classList.toggle("active", showingSaved);

        if (showingSaved) {
            savedPanel.classList.remove("hidden");
            searchPanel.classList.add("hidden");
            savedCount.textContent = savedPlaces.length + " place" + (savedPlaces.length !== 1 ? "s" : "") + " saved";
            clearAllBtn.classList.toggle("hidden", savedPlaces.length === 0);

            if (savedPlaces.length === 0) {
                savedList.innerHTML = '<div class="saved-empty"><div style="font-size:28px;margin-bottom:8px;">‚òÜ</div><p>No saved places yet. Search for shops and tap ‚òÜ to save them here.</p></div>';
            } else {
                savedList.innerHTML = savedPlaces.map(function(item) {
                    return renderCard(item, item.icon, true);
                }).join("");
                attachSaveButtons();
            }
        } else {
            savedPanel.classList.add("hidden");
            searchPanel.classList.remove("hidden");
        }
    }

    function refreshResultSaveButtons() {
        var btns = resultsDiv.querySelectorAll(".save-btn");
        btns.forEach(function(btn) {
            var idx = parseInt(btn.getAttribute("data-idx"));
            var item = currentResults[idx];
            if (item) {
                var s = isSavedItem(item);
                btn.textContent = s ? "‚òÖ" : "‚òÜ";
                btn.className = "save-btn " + (s ? "saved" : "unsaved");
            }
        });
    }

    savedBtn.addEventListener("click", function() {
        showingSaved = !showingSaved;
        if (showingSaved) emptyState.style.display = "none";
        refreshSavedUI();
    });

    clearAllBtn.addEventListener("click", function() {
        if (confirm("Remove all saved places?")) {
            savedPlaces = []; persistSaved(); refreshSavedUI(); refreshResultSaveButtons();
        }
    });

    // ========== UI update ==========
    function updateUI() {
        document.getElementById("locationWrapper").classList.toggle("hidden", shopType !== "physical");
        document.getElementById("searchModeWrapper").classList.toggle("hidden", !shopType);
        document.getElementById("categoryWrapper").classList.toggle("hidden", !shopType || searchMode !== "category");
        document.getElementById("nameWrapper").classList.toggle("hidden", !shopType || searchMode !== "name");

        document.getElementById("btnPhysical").classList.toggle("active", shopType === "physical");
        document.getElementById("btnOnline").classList.toggle("active", shopType === "online");
        document.getElementById("btnCategory").classList.toggle("active", searchMode === "category");
        document.getElementById("btnName").classList.toggle("active", searchMode === "name");

        var term = getSearchTerm();
        var canSearch = term && shopType && (shopType === "online" || selectedLocation);
        searchBtn.disabled = !canSearch || isSearching;
        searchBtn.textContent = isSearching ? "Searching..." : "Search";

        var hint = "";
        if (!shopType) hint = "Choose a shop type above to get started";
        else if (shopType === "physical" && !selectedLocation && term) hint = "Select a location to search for physical shops";
        hintArea.innerHTML = hint ? '<p class="hint">' + hint + '</p>' : '';
    }

    // ========== Buttons ==========
    document.getElementById("btnPhysical").addEventListener("click", function() { shopType = "physical"; updateUI(); });
    document.getElementById("btnOnline").addEventListener("click", function() { shopType = "online"; updateUI(); });
    document.getElementById("btnCategory").addEventListener("click", function() { searchMode = "category"; updateUI(); });
    document.getElementById("btnName").addEventListener("click", function() { searchMode = "name"; updateUI(); });

    nameInput.addEventListener("input", function() {
        nameClear.style.display = nameInput.value ? "block" : "none";
        updateUI();
    });
    nameClear.addEventListener("click", function() { nameInput.value = ""; nameClear.style.display = "none"; updateUI(); });

    // ========== Dropdowns ==========
    function setupDropdown(inputEl, listEl, clearEl, items, onSelect, getSelected) {
        function render(filter) {
            var f = (filter || "").toLowerCase();
            var matched = items.filter(function(item) { return item.toLowerCase().indexOf(f) !== -1; });
            if (matched.length === 0) {
                listEl.innerHTML = '<div class="dropdown-empty">No matches</div>';
            } else {
                listEl.innerHTML = matched.map(function(item) {
                    return '<div class="dropdown-item">' + escapeHtml(item) + '</div>';
                }).join("");
                listEl.querySelectorAll(".dropdown-item").forEach(function(el) {
                    el.addEventListener("mousedown", function(e) {
                        e.preventDefault();
                        onSelect(el.textContent);
                        inputEl.value = el.textContent;
                        clearEl.style.display = "block";
                        listEl.classList.remove("open");
                        updateUI();
                    });
                });
            }
        }
        inputEl.addEventListener("focus", function() { inputEl.value = ""; render(""); listEl.classList.add("open"); });
        inputEl.addEventListener("input", function() { render(inputEl.value); listEl.classList.add("open"); });
        inputEl.addEventListener("blur", function() {
            setTimeout(function() {
                listEl.classList.remove("open");
                var sel = getSelected();
                if (sel) { inputEl.value = sel; clearEl.style.display = "block"; }
                else { inputEl.value = ""; clearEl.style.display = "none"; }
            }, 150);
        });
        clearEl.addEventListener("click", function() { onSelect(""); inputEl.value = ""; clearEl.style.display = "none"; updateUI(); });
    }

    setupDropdown(
        document.getElementById("locationInput"), document.getElementById("locationList"), document.getElementById("locationClear"),
        UK_LOCATIONS, function(val) { selectedLocation = val; }, function() { return selectedLocation; }
    );
    setupDropdown(
        document.getElementById("categoryInput"), document.getElementById("categoryList"), document.getElementById("categoryClear"),
        CATEGORIES, function(val) { selectedCategory = val; }, function() { return selectedCategory; }
    );

    // ========== Google Places API ‚Äî physical shops ==========
    async function searchPlaces(query, limit) {
        limit = limit || RESULT_LIMIT;
        try {
            var response = await fetch("https://places.googleapis.com/v1/places:searchText", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-Goog-Api-Key": GOOGLE_PLACES_API_KEY,
                    "X-Goog-FieldMask": "places.displayName,places.formattedAddress,places.googleMapsUri,places.rating,places.userRatingCount"
                },
                body: JSON.stringify({
                    textQuery: query,
                    languageCode: "en",
                    regionCode: "GB",
                    maxResultCount: limit
                })
            });
            var data = await response.json();
            if (!data.places) return [];
            return data.places.map(function(p) {
                var snippet = p.formattedAddress || "";
                if (p.rating) snippet += " ¬∑ ‚≠ê " + p.rating + (p.userRatingCount ? " (" + p.userRatingCount + ")" : "");
                return {
                    name: (p.displayName && p.displayName.text) || "Unknown",
                    url: p.googleMapsUri || "#",
                    snippet: snippet
                };
            }).slice(0, limit);
        } catch(e) { return []; }
    }

    // ========== Google Custom Search API ‚Äî Etsy online shops ==========
    async function searchEtsy(query, limit) {
        limit = limit || RESULT_LIMIT;
        try {
            var url = "https://www.googleapis.com/customsearch/v1?key=" + GOOGLE_SEARCH_API_KEY +
                "&cx=" + GOOGLE_SEARCH_CX +
                "&q=" + encodeURIComponent(query) +
                "&num=" + Math.min(limit, 10);
            var response = await fetch(url);
            var data = await response.json();
            if (data.error) return [{ name: "API Error", url: "#", snippet: data.error.message || JSON.stringify(data.error) }];
            if (!data.items) return [];
            return data.items.map(function(item) {
                return {
                    name: (item.title || "").replace(/ \| Etsy.*$/i, "").replace(/ - Etsy.*$/i, "").trim(),
                    url: item.link || "#",
                    snippet: item.snippet || ""
                };
            }).slice(0, limit);
        } catch(e) { return [{ name: "Error", url: "#", snippet: e.message }]; }
    }

    // ========== Card rendering ==========
    function renderCard(r, icon, isSavedCard) {
        var itemSaved = isSavedItem(r);
        var iconHtml = icon ? '<div class="category-icon">' + icon + '</div>' : '';
        var urlHtml = icon ? '' : '<div class="result-url">' + escapeHtml(r.displayUrl || r.url) + '</div>';
        var btnClass = itemSaved ? "save-btn saved" : "save-btn unsaved";
        var btnText = itemSaved ? "‚òÖ" : "‚òÜ";
        var dataAttr = isSavedCard
            ? 'data-saved-name="' + escapeHtml(r.name) + '" data-saved-url="' + escapeHtml(r.url) + '"'
            : 'data-idx="' + currentResults.indexOf(r) + '"';

        return '<div class="result-card">' +
            iconHtml +
            '<a href="' + escapeHtml(r.url) + '" target="_blank" rel="noopener noreferrer">' +
                '<div class="result-name">' + escapeHtml(r.name) + '</div>' +
                '<div class="result-snippet">' + escapeHtml(r.snippet) + '</div>' +
                urlHtml +
            '</a>' +
            '<button class="' + btnClass + '" ' + dataAttr + ' title="' + (itemSaved ? "Remove from saved" : "Save this shop") + '">' + btnText + '</button>' +
        '</div>';
    }

    function attachSaveButtons() {
        document.querySelectorAll(".save-btn").forEach(function(btn) {
            btn.onclick = function(e) {
                e.stopPropagation();
                var savedName = btn.getAttribute("data-saved-name");
                var savedUrl = btn.getAttribute("data-saved-url");
                if (savedName !== null) {
                    removeSaved({ name: savedName, url: savedUrl });
                } else {
                    var idx = parseInt(btn.getAttribute("data-idx"));
                    var item = currentResults[idx];
                    if (item) {
                        if (isSavedItem(item)) removeSaved(item);
                        else addSaved(item);
                    }
                }
            };
        });
    }

    function renderSectionHeader(icon, title, color, id) {
        return '<div class="section-header">' +
            '<span class="section-icon" style="background:' + color + '15;">' + icon + '</span>' +
            '<div><div class="section-title">' + title + '</div>' +
            '<div class="section-count" id="count-' + id + '">Searching...</div></div>' +
            '<div class="spinner" id="spinner-' + id + '" style="border-top-color:' + color + ';"></div></div>';
    }

    function updateSection(id, count) {
        var countEl = document.getElementById("count-" + id);
        var spinnerEl = document.getElementById("spinner-" + id);
        if (countEl) countEl.textContent = count + " result" + (count !== 1 ? "s" : "") + " found";
        if (spinnerEl) spinnerEl.remove();
    }

    // ========== Main search ==========
    searchBtn.addEventListener("click", async function() {
        var term = getSearchTerm();
        if (!term || !shopType || isSearching) return;
        if (shopType === "physical" && !selectedLocation) return;

        isSearching = true;
        showingSaved = false;
        refreshSavedUI();
        updateUI();
        emptyState.style.display = "none";

        var sectionIcon = shopType === "physical" ? "üè™" : "üåê";
        var sectionTitle = shopType === "physical" ? "Shops in " + escapeHtml(selectedLocation) : "Online shops";
        var sectionColor = shopType === "physical" ? "#2ecc71" : "#8e44ad";

        resultsDiv.innerHTML = renderSectionHeader(sectionIcon, sectionTitle, sectionColor, "results") +
            '<div id="results-list"></div>';

        var results;
        if (shopType === "physical") {
            var query = selectedLocation + " " + term;
            var icon = CATEGORY_ICONS[term] || "üõçÔ∏è";
            var raw = await searchPlaces(query, RESULT_LIMIT);
            results = raw.map(function(r) { return { name: r.name, url: r.url, snippet: r.snippet, icon: icon }; });
            currentResults = results;
            updateSection("results", results.length);
            document.getElementById("results-list").innerHTML = results.length > 0
                ? results.map(function(r) { return renderCard(r, icon, false); }).join("")
                : '<p class="no-results">No results found. Try a different search.</p>';
        } else {
            var etsyQuery = "uk shop " + term;
            var rawEtsy = await searchEtsy(etsyQuery, RESULT_LIMIT);
            results = rawEtsy.map(function(item) {
                var url = item.url || "";
                var m = url.match(/etsy\.com(?:\/uk)?\/shop\/([A-Za-z0-9_]+)/);
                if (m) url = "https://www.etsy.com/uk/shop/" + m[1];
                return { name: item.name, snippet: item.snippet, displayUrl: url, url: etsyAffiliateUrl(url) };
            });
            currentResults = results;
            updateSection("results", results.length);
            document.getElementById("results-list").innerHTML = results.length > 0
                ? results.map(function(r) { return renderCard(r, null, false); }).join("")
                : '<p class="no-results">No results found. Try a different search.</p>';
        }

        attachSaveButtons();
        isSearching = false;
        updateUI();
    });

    // ========== Init ==========
    updateUI();
    refreshSavedUI();
    </script>
</body>
</html>
