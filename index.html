<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ShopFinder UK</title>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'DM Sans', sans-serif; background: linear-gradient(160deg, #faf8f4 0%, #f0ece4 100%); min-height: 100vh; }
        @keyframes spin { to { transform: rotate(360deg); } }

        .header { background: #1a1a2e; padding: 40px 20px 36px; text-align: center; border-bottom: 3px solid #c9a96e; }
        .header h1 { font-family: 'Playfair Display', serif; font-size: 30px; color: #e8d5b7; margin: 0 0 6px; letter-spacing: -0.5px; }
        .header p { color: rgba(232,213,183,0.5); font-size: 14px; }
        .container { max-width: 600px; margin: 0 auto; padding: 28px 20px; }
        .field-label { font-size: 11px; font-weight: 700; color: #999; text-transform: uppercase; letter-spacing: 0.5px; display: block; margin-bottom: 6px; }
        .field-label-mb8 { margin-bottom: 8px; }

        .list-pill { flex-shrink: 0; padding: 8px 12px; border-radius: 8px; border: 2px solid #e0dbd2; background: #fff; color: #1a1a2e; cursor: pointer; font-size: 12px; font-weight: 600; display: flex; align-items: center; gap: 5px; transition: all 0.15s; white-space: nowrap; font-family: 'DM Sans', sans-serif; }
        .list-pill-active { border-color: #c9a96e; background: #faf6ee; }
        .list-pill-badge { background: #1a1a2e; color: #e8d5b7; font-size: 10px; font-weight: 700; padding: 1px 6px; border-radius: 8px; }
        .save-popup-item { display: block; width: 100%; text-align: left; padding: 9px 14px; border: none; background: none; cursor: pointer; font-size: 13px; color: #1a1a2e; font-weight: 500; font-family: 'DM Sans', sans-serif; }
        .save-popup-item:hover { background: #faf6ee; }

        .toggle-row { display: flex; gap: 8px; margin-bottom: 16px; }
        .toggle-btn { flex: 1; padding: 14px 12px; border-radius: 10px; border: 2px solid #e0dbd2; background: #fff; color: #555; cursor: pointer; text-align: center; transition: all 0.15s; font-family: 'DM Sans', sans-serif; }
        .toggle-btn.active { border-color: #1a1a2e; background: #1a1a2e; color: #e8d5b7; }
        .toggle-btn .label { font-size: 15px; font-weight: 600; }
        .toggle-btn .sublabel { font-size: 11px; margin-top: 2px; color: #aaa; }
        .toggle-btn.active .sublabel { color: rgba(232,213,183,0.6); }

        .toggle-row-sm { display: flex; gap: 6px; margin-bottom: 12px; }
        .toggle-btn-sm { flex: 1; padding: 9px 12px; border-radius: 8px; border: 2px solid #e0dbd2; background: #fff; color: #555; cursor: pointer; font-size: 13px; font-weight: 600; transition: all 0.15s; font-family: 'DM Sans', sans-serif; position: relative; }
        .toggle-btn-sm.active { border-color: #1a1a2e; background: #1a1a2e; color: #e8d5b7; }
        .toggle-btn-sm .tooltip { display: none; position: absolute; bottom: calc(100% + 8px); left: 50%; transform: translateX(-50%); background: #1a1a2e; color: #e8d5b7; font-size: 12px; font-weight: 400; padding: 8px 12px; border-radius: 8px; white-space: normal; width: 240px; text-align: center; line-height: 1.4; z-index: 100; pointer-events: none; box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        .toggle-btn-sm .tooltip::after { content: ''; position: absolute; top: 100%; left: 50%; transform: translateX(-50%); border: 6px solid transparent; border-top-color: #1a1a2e; }
        .toggle-btn-sm:hover .tooltip { display: block; }

        .dropdown-wrapper { position: relative; margin-bottom: 12px; }
        .dropdown-input { width: 100%; padding: 13px 40px 13px 16px; border-radius: 10px; border: 2px solid #e0dbd2; font-size: 15px; outline: none; background: #fff; font-family: 'DM Sans', sans-serif; }
        .dropdown-clear { position: absolute; right: 14px; top: 50%; transform: translateY(-50%); cursor: pointer; color: #bbb; font-size: 18px; line-height: 1; background: none; border: none; display: none; }
        .dropdown-list { position: absolute; top: 100%; left: 0; right: 0; z-index: 50; background: #fff; border-radius: 0 0 10px 10px; box-shadow: 0 8px 24px rgba(0,0,0,0.1); max-height: 220px; overflow-y: auto; border: 1px solid #e0dbd2; border-top: none; display: none; }
        .dropdown-list.open { display: block; }
        .dropdown-item { padding: 10px 16px; cursor: pointer; font-size: 14px; color: #333; }
        .dropdown-item:hover { background: #faf6ee; }
        .dropdown-empty { padding: 12px 16px; color: #aaa; font-size: 13px; }

        .text-input-wrapper { margin-bottom: 12px; }
        .text-input { width: 100%; padding: 13px 40px 13px 16px; border-radius: 10px; border: 2px solid #e0dbd2; font-size: 15px; outline: none; background: #fff; font-family: 'DM Sans', sans-serif; }
        .text-clear { position: absolute; right: 14px; top: 50%; transform: translateY(-50%); cursor: pointer; color: #bbb; font-size: 18px; line-height: 1; background: none; border: none; }

        .search-btn { width: 100%; padding: 13px 28px; border-radius: 10px; border: none; background: #1a1a2e; color: #e8d5b7; font-size: 15px; font-weight: 700; cursor: pointer; margin-bottom: 8px; font-family: 'DM Sans', sans-serif; }
        .search-btn:disabled { opacity: 0.4; cursor: not-allowed; }
        .hint { font-size: 12px; color: #c9a96e; text-align: center; margin: 4px 0 0; }

        .section-header { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; margin-top: 24px; }
        .section-icon { font-size: 20px; width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; border-radius: 8px; }
        .section-title { font-weight: 700; font-size: 15px; color: #1a1a2e; }
        .section-count { font-size: 12px; color: #aaa; }
        .spinner { margin-left: auto; width: 18px; height: 18px; border: 2px solid #e0dbd2; border-radius: 50%; animation: spin 0.8s linear infinite; }

        .result-card { display: flex; gap: 12px; background: #fff; border-radius: 8px; padding: 10px 12px; color: #1a1a2e; border: 1px solid #eee; transition: all 0.15s; margin-bottom: 6px; align-items: center; }
        .result-card:hover { box-shadow: 0 3px 12px rgba(0,0,0,0.07); border-color: #d0c9be; }
        .result-card a { text-decoration: none; color: #1a1a2e; min-width: 0; flex: 1; }
        .result-name { font-weight: 600; font-size: 14px; margin-bottom: 2px; line-height: 1.3; }
        .result-snippet { font-size: 12px; color: #888; line-height: 1.4; overflow: hidden; text-overflow: ellipsis; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; }
        .result-url { font-size: 11px; color: #b0a890; margin-top: 4px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .category-icon { width: 56px; height: 56px; border-radius: 8px; background: #f8f5ef; flex-shrink: 0; display: flex; align-items: center; justify-content: center; font-size: 28px; }

        .save-btn { flex-shrink: 0; width: 36px; height: 36px; border-radius: 8px; border: none; cursor: pointer; font-size: 16px; display: flex; align-items: center; justify-content: center; transition: all 0.15s; }
        .save-btn.unsaved { background: #f8f5ef; color: #999; }
        .save-btn.saved { background: #1a1a2e; color: #e8d5b7; }

        .clear-all-btn { background: none; border: 1px solid #e0dbd2; border-radius: 6px; padding: 4px 10px; font-size: 11px; color: #999; cursor: pointer; font-family: 'DM Sans', sans-serif; }
        .clear-all-btn:hover { border-color: #ccc; color: #666; }
        .share-btn { background: #1a1a2e; border: none; border-radius: 6px; padding: 4px 10px; font-size: 11px; color: #e8d5b7; cursor: pointer; font-family: 'DM Sans', sans-serif; font-weight: 600; }
        .share-btn:hover { background: #2a2a4e; }
        .shared-view { background: #fff; border-radius: 10px; border: 1px solid #e0dbd2; padding: 20px; margin-bottom: 16px; }
        .shared-view h2 { font-family: 'Playfair Display', serif; font-size: 20px; color: #1a1a2e; margin-bottom: 4px; }
        .shared-view .shared-meta { font-size: 12px; color: #aaa; margin-bottom: 16px; }
        .shared-view .shared-back { display: inline-block; margin-top: 16px; font-size: 13px; color: #c9a96e; text-decoration: none; font-weight: 600; }
        .toast { position: fixed; bottom: 24px; left: 50%; transform: translateX(-50%); background: #1a1a2e; color: #e8d5b7; padding: 10px 20px; border-radius: 8px; font-size: 13px; font-weight: 600; z-index: 2000; opacity: 0; transition: opacity 0.3s; pointer-events: none; }

        .saved-empty { text-align: center; padding: 24px 16px; background: #fff; border-radius: 8px; border: 1px solid #eee; }
        .saved-empty p { font-size: 13px; color: #aaa; margin: 0; }

        .empty-state { text-align: center; padding: 40px 20px; }
        .empty-state .icon { font-size: 40px; margin-bottom: 12px; }
        .empty-state p { font-size: 14px; color: #bbb; }
        .no-results { color: #bbb; font-size: 13px; margin: 4px 0 0; padding: 8px 0; }
        .disclosure { font-size: 11px; color: #bbb; text-align: center; margin-top: 32px; padding: 12px 0; border-top: 1px solid #e8e2d8; }
        .hidden { display: none !important; }
    </style>
</head>
<body>
    <div class="header">
        <div style="font-size: 36px; margin-bottom: 8px;">üõçÔ∏è</div>
        <h1>ShopFinder UK</h1>
        <p>Discover independent shops across the UK</p>
    </div>

    <div class="container">
        <!-- Save Popup (choose list) -->
        <div class="hidden" id="savePopup" style="position:fixed;z-index:1000;background:#fff;border-radius:10px;box-shadow:0 8px 32px rgba(0,0,0,0.18);border:1px solid #e0dbd2;padding:8px 0;min-width:200px;">
            <div style="padding:6px 14px 8px;font-size:11px;font-weight:700;color:#999;text-transform:uppercase;letter-spacing:0.5px;">Save to list</div>
            <div id="savePopupList"></div>
        </div>

        <!-- 5 List Buttons -->
        <div style="display:flex;gap:6px;overflow-x:auto;margin-bottom:16px;padding-bottom:4px;" id="listButtons"></div>

        <!-- Active List Panel -->
        <div class="hidden" id="listPanel">
            <div style="display:flex;align-items:center;gap:10px;margin-bottom:10px;margin-top:8px;">
                <span class="section-icon" style="background:#c9a96e15;">‚òÖ</span>
                <div style="flex:1;">
                    <div id="listNameRow" style="display:flex;align-items:center;gap:6px;">
                        <div class="section-title" id="listTitle"></div>
                        <button id="editNameBtn" style="background:none;border:none;cursor:pointer;font-size:14px;color:#aaa;padding:2px;">‚úèÔ∏è</button>
                    </div>
                    <input type="text" id="listNameInput" class="hidden" style="font-weight:700;font-size:15px;color:#1a1a2e;border:1px solid #c9a96e;border-radius:6px;padding:4px 8px;width:100%;outline:none;box-sizing:border-box;" />
                    <div class="section-count" id="listCount">0 places saved</div>
                </div>
                <button class="clear-all-btn hidden" id="clearListBtn">Clear all</button>
                <button class="share-btn hidden" id="shareListBtn">üì§ Share</button>
            </div>
            <div id="listItems"></div>
        </div>

        <!-- Shared list view (for people opening a shared link) -->
        <div class="hidden" id="sharedView">
            <div class="shared-view">
                <h2 id="sharedTitle"></h2>
                <div class="shared-meta" id="sharedMeta"></div>
                <div id="sharedItems"></div>
                <a href="#" class="shared-back" id="sharedBackBtn">‚Üê Start finding your own shops</a>
            </div>
        </div>

        <div id="searchPanel">
            <div>
                <label class="field-label field-label-mb8">Search for</label>
                <div class="toggle-row">
                    <button class="toggle-btn" id="btnPhysical" data-type="physical">
                        <div class="label">üè™ In your city</div>
                        <div class="sublabel">Experiences close by</div>
                    </button>
                    <button class="toggle-btn" id="btnOnline" data-type="online">
                        <div class="label">üåê Online</div>
                        <div class="sublabel">Shipping to the UK</div>
                    </button>
                </div>
            </div>

            <div class="dropdown-wrapper hidden" id="locationWrapper">
                <label class="field-label">Your location</label>
                <div style="position:relative;">
                    <input type="text" class="dropdown-input" id="locationInput" placeholder="Select a town or city..." autocomplete="off" />
                    <button class="dropdown-clear" id="locationClear">√ó</button>
                </div>
                <div class="dropdown-list" id="locationList"></div>
            </div>

            <div class="hidden" id="searchModeWrapper">
                <label class="field-label field-label-mb8">Search by</label>
                <div class="toggle-row-sm">
                    <button class="toggle-btn-sm active" id="btnCategory">Category</button>
                    <button class="toggle-btn-sm" id="btnName">Name<span class="tooltip">Write the name of a specific place or paste the link to an online shop</span></button>
                </div>
            </div>

            <div class="hidden" id="categoryTypeWrapper">
                <label class="field-label field-label-mb8">Category type</label>
                <div class="toggle-row-sm">
                    <button class="toggle-btn-sm" id="btnShops">üõçÔ∏è Shops</button>
                    <button class="toggle-btn-sm" id="btnFood">üçΩÔ∏è Food & Drink</button>
                </div>
            </div>

            <div class="dropdown-wrapper hidden" id="categoryWrapper">
                <label class="field-label">What are you looking for?</label>
                <div style="position:relative;">
                    <input type="text" class="dropdown-input" id="categoryInput" placeholder="Select a category..." autocomplete="off" />
                    <button class="dropdown-clear" id="categoryClear">√ó</button>
                </div>
                <div class="dropdown-list" id="categoryList"></div>
            </div>

            <div class="text-input-wrapper hidden" id="nameWrapper">
                <label class="field-label">Name</label>
                <div style="position:relative;">
                    <input type="text" class="text-input" id="nameInput" placeholder="e.g., Hotel Chocolat, Wetherspoons" />
                    <button class="text-clear" id="nameClear" style="display:none;">√ó</button>
                </div>
            </div>

            <button class="search-btn" id="searchBtn" disabled>Search</button>
            <div id="hintArea"></div>
            <div id="resultsDiv"></div>
        </div>

        <p class="disclosure">Results powered by Brave Search and Google Places.</p>
    </div>
    <div class="toast" id="toast"></div>

    <script>
    // ========================================
    // SETTINGS
    // ========================================
    var GOOGLE_PLACES_API_KEY = "AIzaSyCsm5h-xdvVbeuYRIY3YEUoJiQIs3VDYdA";
    var WORKER_URL = "https://shopfinder-worker.shopfinder.workers.dev";
    var RESULT_LIMIT = 10;
    var STORAGE_KEY = "shopfinder_lists";

    var SHOP_CATEGORIES = {
        "Animals & Pets":"üêæ","Arts and Crafts":"üé®","Beauty & Make-up":"üíÑ",
        "Beer, Wine & Spirits":"üç∑","Books":"üìö","Cars & Motorbikes":"üöó",
        "Charity":"üíõ","Chocolatier":"üç´","Cinema and Theatre":"üé≠",
        "Comics & Manga":"üí¨","Computing":"üíª","Cooking":"üç≥",
        "Fashion & Clothing":"üëó","Footwear":"üëü","Furniture":"ü™ë",
        "Gardening":"üå±","Haberdashery (Sewing & Knitting)":"üßµ",
        "Jewellery":"üíé","Painting & Photography":"üñºÔ∏è",
        "Sports & Fitness":"‚öΩ","Sweets & Confectionary":"üç¨",
        "Toys & Games":"üß∏","Video Games":"üéÆ"
    };
    var FOOD_CATEGORIES = {
        "Bakeries":"üçû","Bars":"üç∏","Caf√©s and Tearooms":"‚òï",
        "Chinese Food":"ü•°","Desserts":"üç∞","Greek Food":"ü´í",
        "Indian Food":"üçõ","Italian Food":"üçï","Pubs":"üç∫"
    };
    var ALL_CATEGORY_ICONS = Object.assign({}, SHOP_CATEGORIES, FOOD_CATEGORIES);
    var UK_LOCATIONS = [
        "Aberdeen","Bath","Belfast","Birmingham","Blackburn","Blackpool","Bolton","Bournemouth",
        "Bradford","Brighton","Bristol","Burnley","Cambridge","Canterbury","Cardiff","Carlisle",
        "Chelmsford","Cheltenham","Chester","Colchester","Coventry","Crawley","Darlington","Derby",
        "Doncaster","Dover","Dundee","Durham","Edinburgh","Exeter","Glasgow","Gloucester",
        "Grimsby","Guildford","Halifax","Harrogate","Huddersfield","Hull","Inverness","Ipswich",
        "Keighley","Lancaster","Leeds","Leicester","Lincoln","Liverpool","London","Luton",
        "Macclesfield","Manchester","Middlesbrough","Milton Keynes","Newcastle","Northampton",
        "Norwich","Nottingham","Oldham","Oxford","Perth","Peterborough","Plymouth","Portsmouth",
        "Preston","Reading","Rochdale","Rotherham","Saltaire","Scarborough","Sheffield","Shipley",
        "Shrewsbury","Skipton","Southampton","Southend","St Albans","Stockport","Stoke-on-Trent",
        "Sunderland","Swansea","Swindon","Taunton","Wakefield","Walsall","Warrington","Wigan",
        "Winchester","Wolverhampton","Worcester","York"
    ];

    // ========== Multi-list save system ==========
    var DEFAULT_LISTS = [
        { name: "My birthday gifts and restaurants", items: [] },
        { name: "Clothes near me and online", items: [] },
        { name: "Drinks in York and Leeds", items: [] },
        { name: "My places", items: [] },
        { name: "More places", items: [] }
    ];

    function loadLists() {
        try {
            var data = JSON.parse(localStorage.getItem(STORAGE_KEY));
            if (Array.isArray(data) && data.length === 5) return data;
            return JSON.parse(JSON.stringify(DEFAULT_LISTS));
        } catch(e) { return JSON.parse(JSON.stringify(DEFAULT_LISTS)); }
    }
    function persistLists() { localStorage.setItem(STORAGE_KEY, JSON.stringify(lists)); }
    function isSavedItem(item) {
        return lists.some(function(l) { return l.items.some(function(s) { return s.name === item.name && s.url === item.url; }); });
    }
    function addToList(listIdx, item) {
        var l = lists[listIdx];
        if (!l.items.some(function(s) { return s.name === item.name && s.url === item.url; })) {
            l.items.push({ name: item.name, url: item.url, snippet: item.snippet, icon: item.icon || null, savedAt: Date.now() });
        }
        persistLists(); refreshListButtons(); refreshResultSaveButtons();
    }
    function removeFromList(listIdx, item) {
        lists[listIdx].items = lists[listIdx].items.filter(function(s) { return !(s.name === item.name && s.url === item.url); });
        persistLists(); refreshListButtons(); refreshListPanel(); refreshResultSaveButtons();
    }
    function removeFromAnyList(item) {
        lists.forEach(function(l) { l.items = l.items.filter(function(s) { return !(s.name === item.name && s.url === item.url); }); });
        persistLists(); refreshListButtons(); refreshListPanel(); refreshResultSaveButtons();
    }
    var lists = loadLists();

    // ========== State ==========
    var shopType = "";
    var searchMode = "category";
    var categoryType = "";
    var selectedLocation = "";
    var selectedCategory = "";
    var isSearching = false;
    var activeList = -1; // -1 = none open
    var currentResults = [];

    // ========== DOM refs ==========
    var searchBtn = document.getElementById("searchBtn");
    var resultsDiv = document.getElementById("resultsDiv");
    var hintArea = document.getElementById("hintArea");
    var nameInput = document.getElementById("nameInput");
    var nameClear = document.getElementById("nameClear");
    var searchPanel = document.getElementById("searchPanel");
    var listPanel = document.getElementById("listPanel");
    var listButtonsDiv = document.getElementById("listButtons");
    var savePopupEl = document.getElementById("savePopup");
    var savePopupList = document.getElementById("savePopupList");

    function escapeHtml(str) {
        var div = document.createElement('div');
        div.appendChild(document.createTextNode(str || ""));
        return div.innerHTML;
    }

    function getSearchTerm() {
        return searchMode === "category" ? selectedCategory : (nameInput.value || "").trim();
    }

    // ========== List Buttons ==========
    function refreshListButtons() {
        listButtonsDiv.innerHTML = lists.map(function(l, i) {
            var isActive = activeList === i;
            return '<button class="list-pill' + (isActive ? ' list-pill-active' : '') + '" data-list-idx="' + i + '">' +
                '<span style="font-size:14px;">‚òÖ</span>' +
                '<span style="max-width:120px;overflow:hidden;text-overflow:ellipsis;">' + escapeHtml(l.name) + '</span>' +
                (l.items.length > 0 ? '<span class="list-pill-badge">' + l.items.length + '</span>' : '') +
                '</button>';
        }).join("");
        listButtonsDiv.querySelectorAll(".list-pill").forEach(function(btn) {
            btn.addEventListener("click", function() {
                var idx = parseInt(btn.getAttribute("data-list-idx"));
                activeList = activeList === idx ? -1 : idx;
                refreshListButtons();
                refreshListPanel();
                
            });
        });
    }

    // ========== List Panel ==========
    function refreshListPanel() {
        if (activeList < 0) {
            listPanel.classList.add("hidden");
            searchPanel.classList.remove("hidden");
            return;
        }
        listPanel.classList.remove("hidden");
        searchPanel.classList.add("hidden");

        var l = lists[activeList];
        document.getElementById("listTitle").textContent = l.name;
        document.getElementById("listNameRow").classList.remove("hidden");
        document.getElementById("listNameInput").classList.add("hidden");
        document.getElementById("listCount").textContent = l.items.length + " place" + (l.items.length !== 1 ? "s" : "") + " saved";
        document.getElementById("clearListBtn").classList.toggle("hidden", l.items.length === 0);
        document.getElementById("shareListBtn").classList.toggle("hidden", l.items.length === 0);

        var listItems = document.getElementById("listItems");
        if (l.items.length === 0) {
            listItems.innerHTML = '<div class="saved-empty"><div style="font-size:28px;margin-bottom:8px;">‚òÜ</div><p>No saved places yet. Search for shops and tap ‚òÜ to save them here.</p></div>';
        } else {
            listItems.innerHTML = l.items.map(function(item) {
                return renderCard(item, item.icon, true);
            }).join("");
            attachSaveButtons();
        }
    }

    // ========== Edit list name ==========
    document.getElementById("editNameBtn").addEventListener("click", function() {
        var input = document.getElementById("listNameInput");
        input.value = lists[activeList].name;
        document.getElementById("listNameRow").classList.add("hidden");
        input.classList.remove("hidden");
        input.focus();
    });

    function commitListName() {
        var input = document.getElementById("listNameInput");
        var val = input.value.trim();
        if (val && activeList >= 0) {
            lists[activeList].name = val;
            persistLists();
        }
        input.classList.add("hidden");
        document.getElementById("listNameRow").classList.remove("hidden");
        refreshListButtons();
        refreshListPanel();
    }
    document.getElementById("listNameInput").addEventListener("keydown", function(e) { if (e.key === "Enter") commitListName(); });
    document.getElementById("listNameInput").addEventListener("blur", commitListName);

    // ========== Clear list ==========
    document.getElementById("clearListBtn").addEventListener("click", function() {
        if (activeList >= 0 && confirm('Clear all items from "' + lists[activeList].name + '"?')) {
            lists[activeList].items = [];
            persistLists(); refreshListButtons(); refreshListPanel(); refreshResultSaveButtons();
        }
    });

    // ========== Toast ==========
    function showToast(msg) {
        var t = document.getElementById("toast");
        t.textContent = msg;
        t.style.opacity = "1";
        setTimeout(function() { t.style.opacity = "0"; }, 2200);
    }

    // ========== Share list ==========
    function encodeListForShare(listObj) {
        var compact = { n: listObj.name, i: listObj.items.map(function(item) { return { n: item.name, u: item.url, s: item.snippet || "" }; }) };
        return btoa(unescape(encodeURIComponent(JSON.stringify(compact))));
    }

    function decodeSharedList(encoded) {
        try {
            var json = decodeURIComponent(escape(atob(encoded)));
            var d = JSON.parse(json);
            return { name: d.n, items: d.i.map(function(item) { return { name: item.n, url: item.u, snippet: item.s }; }) };
        } catch(e) { return null; }
    }

    document.getElementById("shareListBtn").addEventListener("click", function() {
        if (activeList < 0) return;
        var l = lists[activeList];
        var encoded = encodeListForShare(l);
        var baseUrl = window.location.origin + window.location.pathname;
        var shareUrl = baseUrl + "#shared=" + encoded;

        if (shareUrl.length > 8000) {
            showToast("List is too large to share via link. Try removing some items.");
            return;
        }

        var shareData = { title: l.name + " ‚Äî ShopFinder UK", text: "Check out my ShopFinder list: " + l.name, url: shareUrl };

        if (navigator.share) {
            navigator.share(shareData).catch(function() {});
        } else {
            navigator.clipboard.writeText(shareUrl).then(function() {
                showToast("Link copied to clipboard!");
            }).catch(function() {
                // Fallback: select from a temp input
                var tmp = document.createElement("input");
                tmp.value = shareUrl;
                document.body.appendChild(tmp);
                tmp.select();
                document.execCommand("copy");
                document.body.removeChild(tmp);
                showToast("Link copied to clipboard!");
            });
        }
    });

    // ========== Shared view (for recipients) ==========
    function checkForSharedList() {
        var hash = window.location.hash;
        if (!hash || hash.indexOf("#shared=") !== 0) return false;
        var encoded = hash.substring(8);
        var shared = decodeSharedList(encoded);
        if (!shared || !shared.items || shared.items.length === 0) return false;

        // Hide normal UI, show shared view
        document.getElementById("listButtons").classList.add("hidden");
        document.getElementById("searchPanel").classList.add("hidden");
        
        document.getElementById("sharedView").classList.remove("hidden");

        document.getElementById("sharedTitle").textContent = shared.name;
        document.getElementById("sharedMeta").textContent = shared.items.length + " place" + (shared.items.length !== 1 ? "s" : "") + " shared with you";

        var sharedItemsDiv = document.getElementById("sharedItems");
        sharedItemsDiv.innerHTML = shared.items.map(function(item) {
            return '<div class="result-card">' +
                '<a href="' + escapeHtml(item.url) + '" target="_blank" rel="noopener noreferrer">' +
                    '<div class="result-name">' + escapeHtml(item.name) + '</div>' +
                    '<div class="result-snippet">' + escapeHtml(item.snippet) + '</div>' +
                '</a></div>';
        }).join("");

        return true;
    }

    document.getElementById("sharedBackBtn").addEventListener("click", function(e) {
        e.preventDefault();
        history.replaceState(null, "", window.location.pathname);
        document.getElementById("sharedView").classList.add("hidden");
        document.getElementById("listButtons").classList.remove("hidden");
        document.getElementById("searchPanel").classList.remove("hidden");
        
        updateUI();
    });

    // ========== Save popup ==========
    function showSavePopup(item, btnEl) {
        savePopupList.innerHTML = lists.map(function(l, i) {
            return '<button class="save-popup-item" data-popup-idx="' + i + '">‚òÖ ' + escapeHtml(l.name) + ' <span style="color:#aaa;font-size:11px;">(' + l.items.length + ')</span></button>';
        }).join("");
        savePopupList.querySelectorAll(".save-popup-item").forEach(function(btn) {
            btn.addEventListener("click", function() {
                addToList(parseInt(btn.getAttribute("data-popup-idx")), item);
                hideSavePopup();
            });
        });
        var rect = btnEl.getBoundingClientRect();
        savePopupEl.style.left = Math.min(rect.left, window.innerWidth - 220) + "px";
        savePopupEl.style.top = (rect.bottom + 4) + "px";
        savePopupEl.classList.remove("hidden");
    }
    function hideSavePopup() { savePopupEl.classList.add("hidden"); }
    document.addEventListener("mousedown", function(e) {
        if (!savePopupEl.contains(e.target)) hideSavePopup();
    });

    function refreshResultSaveButtons() {
        var btns = resultsDiv.querySelectorAll(".save-btn");
        btns.forEach(function(btn) {
            var name = btn.getAttribute("data-card-name");
            var url = btn.getAttribute("data-card-url");
            if (name && url) {
                var s = isSavedItem({ name: name, url: url });
                btn.textContent = s ? "‚òÖ" : "‚òÜ";
                btn.className = "save-btn " + (s ? "saved" : "unsaved");
            }
        });
    }

    // Init list buttons
    refreshListButtons();

    // ========== UI update ==========
    function updateUI() {
        document.getElementById("locationWrapper").classList.toggle("hidden", shopType !== "physical");
        document.getElementById("searchModeWrapper").classList.toggle("hidden", !shopType);
        document.getElementById("categoryTypeWrapper").classList.toggle("hidden", !shopType || shopType === "online" || searchMode !== "category");
        document.getElementById("categoryWrapper").classList.toggle("hidden", !shopType || searchMode !== "category" || (!categoryType && shopType !== "online"));
        document.getElementById("nameWrapper").classList.toggle("hidden", !shopType || searchMode !== "name");

        document.getElementById("btnPhysical").classList.toggle("active", shopType === "physical");
        document.getElementById("btnOnline").classList.toggle("active", shopType === "online");
        document.getElementById("btnCategory").classList.toggle("active", searchMode === "category");
        document.getElementById("btnName").classList.toggle("active", searchMode === "name");
        document.getElementById("btnShops").classList.toggle("active", categoryType === "shops");
        document.getElementById("btnFood").classList.toggle("active", categoryType === "food");

        var term = getSearchTerm();
        var canSearch = term && shopType && (shopType === "online" || selectedLocation);
        searchBtn.disabled = !canSearch || isSearching;
        searchBtn.textContent = isSearching ? "Searching..." : "Search";

        var hint = "";
        if (shopType === "physical" && !selectedLocation && term) hint = "Select a location to search for physical shops";
        hintArea.innerHTML = hint ? '<p class="hint">' + hint + '</p>' : '';
    }

    // ========== Buttons ==========
    document.getElementById("btnPhysical").addEventListener("click", function() { shopType = "physical"; categoryType = ""; selectedCategory = ""; document.getElementById("categoryInput").value = ""; document.getElementById("categoryClear").style.display = "none"; refreshCategoryDropdown(); updateUI(); });
    document.getElementById("btnOnline").addEventListener("click", function() { shopType = "online"; categoryType = "shops"; selectedCategory = ""; document.getElementById("categoryInput").value = ""; document.getElementById("categoryClear").style.display = "none"; refreshCategoryDropdown(); updateUI(); });
    document.getElementById("btnCategory").addEventListener("click", function() { searchMode = "category"; updateUI(); });
    document.getElementById("btnName").addEventListener("click", function() { searchMode = "name"; updateUI(); });
    document.getElementById("btnShops").addEventListener("click", function() {
        categoryType = "shops"; selectedCategory = "";
        document.getElementById("categoryInput").value = "";
        document.getElementById("categoryClear").style.display = "none";
        refreshCategoryDropdown();
        updateUI();
    });
    document.getElementById("btnFood").addEventListener("click", function() {
        categoryType = "food"; selectedCategory = "";
        document.getElementById("categoryInput").value = "";
        document.getElementById("categoryClear").style.display = "none";
        refreshCategoryDropdown();
        updateUI();
    });

    nameInput.addEventListener("input", function() {
        nameClear.style.display = nameInput.value ? "block" : "none";
        updateUI();
    });
    nameClear.addEventListener("click", function() { nameInput.value = ""; nameClear.style.display = "none"; updateUI(); });

    // ========== Dropdowns ==========
    function setupDropdown(inputEl, listEl, clearEl, items, onSelect, getSelected) {
        function render(filter) {
            var f = (filter || "").toLowerCase();
            var matched = items.filter(function(item) { return item.toLowerCase().indexOf(f) !== -1; });
            if (matched.length === 0) {
                listEl.innerHTML = '<div class="dropdown-empty">No matches</div>';
            } else {
                listEl.innerHTML = matched.map(function(item) {
                    return '<div class="dropdown-item">' + escapeHtml(item) + '</div>';
                }).join("");
                listEl.querySelectorAll(".dropdown-item").forEach(function(el) {
                    el.addEventListener("mousedown", function(e) {
                        e.preventDefault();
                        onSelect(el.textContent);
                        inputEl.value = el.textContent;
                        clearEl.style.display = "block";
                        listEl.classList.remove("open");
                        updateUI();
                    });
                });
            }
        }
        inputEl.addEventListener("focus", function() { inputEl.value = ""; render(""); listEl.classList.add("open"); });
        inputEl.addEventListener("input", function() { render(inputEl.value); listEl.classList.add("open"); });
        inputEl.addEventListener("blur", function() {
            setTimeout(function() {
                listEl.classList.remove("open");
                var sel = getSelected();
                if (sel) { inputEl.value = sel; clearEl.style.display = "block"; }
                else { inputEl.value = ""; clearEl.style.display = "none"; }
            }, 150);
        });
        clearEl.addEventListener("click", function() { onSelect(""); inputEl.value = ""; clearEl.style.display = "none"; updateUI(); });
    }

    setupDropdown(
        document.getElementById("locationInput"), document.getElementById("locationList"), document.getElementById("locationClear"),
        UK_LOCATIONS, function(val) { selectedLocation = val; }, function() { return selectedLocation; }
    );

    // Dynamic category dropdown ‚Äî items change based on categoryType
    var catInput = document.getElementById("categoryInput");
    var catList = document.getElementById("categoryList");
    var catClear = document.getElementById("categoryClear");

    function getCategoryItems() {
        return categoryType === "food" ? Object.keys(FOOD_CATEGORIES) : Object.keys(SHOP_CATEGORIES);
    }

    function renderCategoryList(filter) {
        var items = getCategoryItems();
        var f = (filter || "").toLowerCase();
        var matched = items.filter(function(item) { return item.toLowerCase().indexOf(f) !== -1; });
        if (matched.length === 0) {
            catList.innerHTML = '<div class="dropdown-empty">No matches</div>';
        } else {
            catList.innerHTML = matched.map(function(item) {
                return '<div class="dropdown-item">' + escapeHtml(item) + '</div>';
            }).join("");
            catList.querySelectorAll(".dropdown-item").forEach(function(el) {
                el.addEventListener("mousedown", function(e) {
                    e.preventDefault();
                    selectedCategory = el.textContent;
                    catInput.value = el.textContent;
                    catClear.style.display = "block";
                    catList.classList.remove("open");
                    updateUI();
                });
            });
        }
    }

    function refreshCategoryDropdown() { renderCategoryList(""); }

    catInput.addEventListener("focus", function() { catInput.value = ""; renderCategoryList(""); catList.classList.add("open"); });
    catInput.addEventListener("input", function() { renderCategoryList(catInput.value); catList.classList.add("open"); });
    catInput.addEventListener("blur", function() {
        setTimeout(function() {
            catList.classList.remove("open");
            if (selectedCategory) { catInput.value = selectedCategory; catClear.style.display = "block"; }
            else { catInput.value = ""; catClear.style.display = "none"; }
        }, 150);
    });
    catClear.addEventListener("click", function() { selectedCategory = ""; catInput.value = ""; catClear.style.display = "none"; updateUI(); });

    // ========== Google Places API ‚Äî physical shops ==========
    async function searchPlaces(query, limit) {
        limit = limit || RESULT_LIMIT;
        try {
            var response = await fetch("https://places.googleapis.com/v1/places:searchText", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-Goog-Api-Key": GOOGLE_PLACES_API_KEY,
                    "X-Goog-FieldMask": "places.displayName,places.formattedAddress,places.googleMapsUri,places.rating,places.userRatingCount"
                },
                body: JSON.stringify({
                    textQuery: query,
                    languageCode: "en",
                    regionCode: "GB",
                    maxResultCount: limit
                })
            });
            var data = await response.json();
            if (!data.places) return [];
            return data.places.map(function(p) {
                var snippet = p.formattedAddress || "";
                if (p.rating) snippet += " ¬∑ ‚≠ê " + p.rating + (p.userRatingCount ? " (" + p.userRatingCount + ")" : "");
                return {
                    name: (p.displayName && p.displayName.text) || "Unknown",
                    url: p.googleMapsUri || "#",
                    snippet: snippet
                };
            }).slice(0, limit);
        } catch(e) { return []; }
    }

    // ========== Worker ‚Üí Brave Search ==========
    async function searchWorker(query, limit) {
        limit = limit || RESULT_LIMIT;
        try {
            var response = await fetch(WORKER_URL, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ query: query, limit: limit })
            });
            var data = await response.json();
            if (data.error) return [];
            return (data.results || []).slice(0, limit);
        } catch(e) { return []; }
    }

    // ========== Card rendering ==========
    function renderCard(r, icon, isSavedCard) {
        var itemSaved = isSavedItem(r);
        var iconHtml = icon ? '<div class="category-icon">' + icon + '</div>' : '';
        var urlHtml = icon ? '' : '<div class="result-url">' + escapeHtml(r.displayUrl || r.url) + '</div>';
        var btnClass = itemSaved ? "save-btn saved" : "save-btn unsaved";
        var btnText = itemSaved ? "‚òÖ" : "‚òÜ";
        var dataAttr = 'data-card-name="' + escapeHtml(r.name) + '" data-card-url="' + escapeHtml(r.url) + '" data-card-snippet="' + escapeHtml(r.snippet || "") + '"';
        if (isSavedCard) dataAttr += ' data-is-saved="1"';

        return '<div class="result-card">' +
            iconHtml +
            '<a href="' + escapeHtml(r.url) + '" target="_blank" rel="noopener noreferrer">' +
                '<div class="result-name">' + escapeHtml(r.name) + '</div>' +
                '<div class="result-snippet">' + escapeHtml(r.snippet) + '</div>' +
                urlHtml +
            '</a>' +
            '<button class="' + btnClass + '" ' + dataAttr + ' title="' + (itemSaved ? "Remove from saved" : "Save this shop") + '">' + btnText + '</button>' +
        '</div>';
    }

    function attachSaveButtons() {
        document.querySelectorAll(".save-btn").forEach(function(btn) {
            btn.onclick = function(e) {
                e.stopPropagation();
                var name = btn.getAttribute("data-card-name");
                var url = btn.getAttribute("data-card-url");
                var snippet = btn.getAttribute("data-card-snippet") || "";
                var item = { name: name, url: url, snippet: snippet };
                if (isSavedItem(item)) {
                    removeFromAnyList(item);
                } else {
                    showSavePopup(item, btn);
                }
            };
        });
    }

    function renderSectionHeader(icon, title, color, id) {
        return '<div class="section-header">' +
            '<span class="section-icon" style="background:' + color + '15;">' + icon + '</span>' +
            '<div><div class="section-title">' + title + '</div>' +
            '<div class="section-count" id="count-' + id + '">Searching...</div></div>' +
            '<div class="spinner" id="spinner-' + id + '" style="border-top-color:' + color + ';"></div></div>';
    }

    function updateSection(id, count) {
        var countEl = document.getElementById("count-" + id);
        var spinnerEl = document.getElementById("spinner-" + id);
        if (countEl) countEl.textContent = count + " result" + (count !== 1 ? "s" : "") + " found";
        if (spinnerEl) spinnerEl.remove();
    }

    // ========== Main search ==========
    searchBtn.addEventListener("click", async function() {
        var term = getSearchTerm();
        if (!term || !shopType || isSearching) return;
        if (shopType === "physical" && !selectedLocation) return;

        isSearching = true;
        activeList = -1;
        refreshListButtons();
        refreshListPanel();
        updateUI();
        
        currentResults = [];

        if (shopType === "physical") {
            resultsDiv.innerHTML = renderSectionHeader("üè™", "Shops in " + escapeHtml(selectedLocation), "#2ecc71", "physical") +
                '<div id="results-physical"></div>';

            var query = selectedLocation + " " + term;
            var icon = ALL_CATEGORY_ICONS[term] || "üõçÔ∏è";
            var raw = await searchPlaces(query, RESULT_LIMIT);
            var results = raw.map(function(r) { return { name: r.name, url: r.url, snippet: r.snippet, icon: icon }; });
            currentResults = results;
            updateSection("physical", results.length);
            document.getElementById("results-physical").innerHTML = results.length > 0
                ? results.map(function(r) { return renderCard(r, icon, false); }).join("")
                : '<p class="no-results">No results found. Try a different search.</p>';

            attachSaveButtons();
            isSearching = false;
            updateUI();
        } else {
            resultsDiv.innerHTML = renderSectionHeader("üåê", "Online results", "#1a1a2e", "online") +
                '<div id="results-online"></div>';

            var raw = await searchWorker(term + " UK shop", RESULT_LIMIT);
            var icon = ALL_CATEGORY_ICONS[term] || "üõçÔ∏è";
            var onlineResults = raw.map(function(item) {
                return { name: (item.name || "").trim(), snippet: item.snippet || "", displayUrl: item.url, url: item.url };
            });
            currentResults = onlineResults;
            updateSection("online", onlineResults.length);
            document.getElementById("results-online").innerHTML = onlineResults.length > 0
                ? onlineResults.map(function(r) { return renderCard(r, icon, false); }).join("")
                : '<p class="no-results">No results found. Try a different search.</p>';

            attachSaveButtons();
            isSearching = false;
            updateUI();
        }
    });

    // ========== Init ==========
    var isSharedView = checkForSharedList();
    if (!isSharedView) updateUI();
    </script>
</body>
</html>
