<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ShopFinder UK</title>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'DM Sans', sans-serif; background: linear-gradient(160deg, #faf8f4 0%, #f0ece4 100%); min-height: 100vh; }
        @keyframes spin { to { transform: rotate(360deg); } }

        .header { background: #1a1a2e; padding: 40px 20px 36px; text-align: center; border-bottom: 3px solid #c9a96e; }
        .header h1 { font-family: 'Playfair Display', serif; font-size: 30px; color: #e8d5b7; margin: 0 0 6px; letter-spacing: -0.5px; }
        .header p { color: rgba(232,213,183,0.5); font-size: 14px; }
        .container { max-width: 600px; margin: 0 auto; padding: 28px 20px; }
        .field-label { font-size: 11px; font-weight: 700; color: #999; text-transform: uppercase; letter-spacing: 0.5px; display: block; margin-bottom: 6px; }
        .field-label-mb8 { margin-bottom: 8px; }

        .toggle-row { display: flex; gap: 8px; margin-bottom: 16px; }
        .toggle-btn { flex: 1; padding: 14px 12px; border-radius: 10px; border: 2px solid #e0dbd2; background: #fff; color: #555; cursor: pointer; text-align: center; transition: all 0.15s; font-family: 'DM Sans', sans-serif; }
        .toggle-btn.active { border-color: #1a1a2e; background: #1a1a2e; color: #e8d5b7; }
        .toggle-btn .label { font-size: 15px; font-weight: 600; }
        .toggle-btn .sublabel { font-size: 11px; margin-top: 2px; color: #aaa; }
        .toggle-btn.active .sublabel { color: rgba(232,213,183,0.6); }

        .toggle-row-sm { display: flex; gap: 6px; margin-bottom: 12px; }
        .toggle-btn-sm { flex: 1; padding: 9px 12px; border-radius: 8px; border: 2px solid #e0dbd2; background: #fff; color: #555; cursor: pointer; font-size: 13px; font-weight: 600; transition: all 0.15s; font-family: 'DM Sans', sans-serif; }
        .toggle-btn-sm.active { border-color: #1a1a2e; background: #1a1a2e; color: #e8d5b7; }

        .dropdown-wrapper { position: relative; margin-bottom: 12px; }
        .dropdown-input { width: 100%; padding: 13px 40px 13px 16px; border-radius: 10px; border: 2px solid #e0dbd2; font-size: 15px; outline: none; background: #fff; font-family: 'DM Sans', sans-serif; }
        .dropdown-clear { position: absolute; right: 14px; top: 50%; transform: translateY(-50%); cursor: pointer; color: #bbb; font-size: 18px; line-height: 1; background: none; border: none; display: none; }
        .dropdown-list { position: absolute; top: 100%; left: 0; right: 0; z-index: 50; background: #fff; border-radius: 0 0 10px 10px; box-shadow: 0 8px 24px rgba(0,0,0,0.1); max-height: 220px; overflow-y: auto; border: 1px solid #e0dbd2; border-top: none; display: none; }
        .dropdown-list.open { display: block; }
        .dropdown-item { padding: 10px 16px; cursor: pointer; font-size: 14px; color: #333; }
        .dropdown-item:hover { background: #faf6ee; }
        .dropdown-empty { padding: 12px 16px; color: #aaa; font-size: 13px; }

        .text-input-wrapper { margin-bottom: 12px; }
        .text-input { width: 100%; padding: 13px 40px 13px 16px; border-radius: 10px; border: 2px solid #e0dbd2; font-size: 15px; outline: none; background: #fff; font-family: 'DM Sans', sans-serif; }
        .text-clear { position: absolute; right: 14px; top: 50%; transform: translateY(-50%); cursor: pointer; color: #bbb; font-size: 18px; line-height: 1; background: none; border: none; }

        .search-btn { width: 100%; padding: 13px 28px; border-radius: 10px; border: none; background: #1a1a2e; color: #e8d5b7; font-size: 15px; font-weight: 700; cursor: pointer; margin-bottom: 8px; font-family: 'DM Sans', sans-serif; }
        .search-btn:disabled { opacity: 0.4; cursor: not-allowed; }
        .hint { font-size: 12px; color: #c9a96e; text-align: center; margin: 4px 0 0; }

        .section-header { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; margin-top: 24px; }
        .section-icon { font-size: 20px; width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; border-radius: 8px; }
        .section-title { font-weight: 700; font-size: 15px; color: #1a1a2e; }
        .section-count { font-size: 12px; color: #aaa; }
        .spinner { margin-left: auto; width: 18px; height: 18px; border: 2px solid #e0dbd2; border-radius: 50%; animation: spin 0.8s linear infinite; }

        .result-card { display: flex; gap: 12px; background: #fff; border-radius: 8px; padding: 10px 12px; text-decoration: none; color: #1a1a2e; border: 1px solid #eee; transition: all 0.15s; margin-bottom: 6px; align-items: center; }
        .result-card:hover { box-shadow: 0 3px 12px rgba(0,0,0,0.07); border-color: #d0c9be; }
        .result-name { font-weight: 600; font-size: 14px; margin-bottom: 2px; line-height: 1.3; }
        .result-snippet { font-size: 12px; color: #888; line-height: 1.4; overflow: hidden; text-overflow: ellipsis; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; }
        .result-url { font-size: 11px; color: #b0a890; margin-top: 4px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .category-icon { width: 56px; height: 56px; border-radius: 8px; background: #f8f5ef; flex-shrink: 0; display: flex; align-items: center; justify-content: center; font-size: 28px; }
        .card-text { min-width: 0; flex: 1; }

        .empty-state { text-align: center; padding: 40px 20px; }
        .empty-state .icon { font-size: 40px; margin-bottom: 12px; }
        .empty-state p { font-size: 14px; color: #bbb; }
        .no-results { color: #bbb; font-size: 13px; margin: 4px 0 0; padding: 8px 0; }
        .disclosure { font-size: 11px; color: #bbb; text-align: center; margin-top: 32px; padding: 12px 0; border-top: 1px solid #e8e2d8; }
        .hidden { display: none !important; }
    </style>
</head>
<body>
    <div class="header">
        <div style="font-size: 36px; margin-bottom: 8px;">üõçÔ∏è</div>
        <h1>ShopFinder UK</h1>
        <p>Discover independent shops across the UK</p>
    </div>

    <div class="container">
        <!-- Shop Type -->
        <div>
            <label class="field-label field-label-mb8">Search for</label>
            <div class="toggle-row">
                <button class="toggle-btn" id="btnPhysical" data-type="physical">
                    <div class="label">üè™ Shops in your city</div>
                    <div class="sublabel">Experiences close by</div>
                </button>
                <button class="toggle-btn" id="btnOnline" data-type="online">
                    <div class="label">üåê Online shops in the UK</div>
                    <div class="sublabel">Low shipping costs</div>
                </button>
            </div>
        </div>

        <!-- Location (physical only) -->
        <div class="dropdown-wrapper hidden" id="locationWrapper">
            <label class="field-label">Your location</label>
            <div style="position:relative;">
                <input type="text" class="dropdown-input" id="locationInput" placeholder="Select a town or city..." autocomplete="off" />
                <button class="dropdown-clear" id="locationClear">√ó</button>
            </div>
            <div class="dropdown-list" id="locationList"></div>
        </div>

        <!-- Search Mode -->
        <div class="hidden" id="searchModeWrapper">
            <label class="field-label field-label-mb8">Search by</label>
            <div class="toggle-row-sm">
                <button class="toggle-btn-sm active" id="btnCategory">Category</button>
                <button class="toggle-btn-sm" id="btnName">Shop name</button>
            </div>
        </div>

        <!-- Category dropdown -->
        <div class="dropdown-wrapper hidden" id="categoryWrapper">
            <label class="field-label">What are you looking for?</label>
            <div style="position:relative;">
                <input type="text" class="dropdown-input" id="categoryInput" placeholder="Select a category..." autocomplete="off" />
                <button class="dropdown-clear" id="categoryClear">√ó</button>
            </div>
            <div class="dropdown-list" id="categoryList"></div>
        </div>

        <!-- Shop name -->
        <div class="text-input-wrapper hidden" id="nameWrapper">
            <label class="field-label">Shop name</label>
            <div style="position:relative;">
                <input type="text" class="text-input" id="nameInput" placeholder="e.g. The Chocolate Factory, Bob's Books..." />
                <button class="text-clear" id="nameClear" style="display:none;">√ó</button>
            </div>
        </div>

        <button class="search-btn" id="searchBtn" disabled>Search</button>
        <div id="hintArea"></div>
        <div id="resultsDiv"></div>
        <div class="empty-state" id="emptyState">
            <div class="icon">üîç</div>
            <p>Choose a shop type and category to start searching</p>
        </div>
        <p class="disclosure">As an Etsy Affiliate, we earn from qualifying purchases.</p>
    </div>

    <script>
    var WORKER_URL = "https://shopfinder-worker.shopfinder.workers.dev";
    var AWIN_PUBLISHER_ID = "000000";
    var AWIN_ETSY_ADVERTISER_ID = "6220";
    var RESULT_LIMIT = 10;

    function etsyAffiliateUrl(url) {
        return "https://www.awin1.com/cread.php?awinmid=" + AWIN_ETSY_ADVERTISER_ID + "&awinaffid=" + AWIN_PUBLISHER_ID + "&ued=" + encodeURIComponent(url);
    }

    var CATEGORY_ICONS = {
        "Animals & Pets":"üêæ","Antiques":"üè∫","Arts and Crafts":"üé®",
        "Bakery":"üçû","Beauty & Make-up":"üíÑ","Beer, Wine & Spirits":"üç∑",
        "Booksellers":"üìö","Butcher":"ü•©","Cars & Motorbikes":"üöó",
        "Charity":"üíõ","Cheesemonger":"üßÄ","Chocolatier":"üç´",
        "Comics & Manga":"üí¨","Computers and Televisions":"üíª",
        "Delicatessen":"ü•ñ","Fashion & Clothing":"üëó","Fishmonger":"üêü",
        "Footwear":"üëü","Gardening":"üå±","Greengrocer":"ü•¨",
        "Haberdashery (Sewing & Knitting)":"üßµ","Health Food":"ü•ó",
        "Jewellery":"üíé","Painting & Photography":"üñºÔ∏è",
        "Sports & Fitness":"‚öΩ","Sweets & Confectionary":"üç¨",
        "Tea and Coffee":"‚òï","Toys & Games":"üß∏","Video Games":"üéÆ"
    };
    var CATEGORIES = Object.keys(CATEGORY_ICONS);
    var UK_LOCATIONS = [
        "Aberdeen","Bath","Belfast","Birmingham","Blackburn","Blackpool","Bolton","Bournemouth",
        "Bradford","Brighton","Bristol","Burnley","Cambridge","Canterbury","Cardiff","Carlisle",
        "Chelmsford","Cheltenham","Chester","Colchester","Coventry","Crawley","Darlington","Derby",
        "Doncaster","Dover","Dundee","Durham","Edinburgh","Exeter","Glasgow","Gloucester",
        "Grimsby","Guildford","Halifax","Harrogate","Huddersfield","Hull","Inverness","Ipswich",
        "Keighley","Lancaster","Leeds","Leicester","Lincoln","Liverpool","London","Luton",
        "Macclesfield","Manchester","Middlesbrough","Milton Keynes","Newcastle","Northampton",
        "Norwich","Nottingham","Oldham","Oxford","Perth","Peterborough","Plymouth","Portsmouth",
        "Preston","Reading","Rochdale","Rotherham","Saltaire","Scarborough","Sheffield","Shipley",
        "Shrewsbury","Skipton","Southampton","Southend","St Albans","Stockport","Stoke-on-Trent",
        "Sunderland","Swansea","Swindon","Taunton","Wakefield","Walsall","Warrington","Wigan",
        "Winchester","Wolverhampton","Worcester","York"
    ];

    var shopType = "";
    var searchMode = "category";
    var selectedLocation = "";
    var selectedCategory = "";
    var isSearching = false;

    var searchBtn = document.getElementById("searchBtn");
    var resultsDiv = document.getElementById("resultsDiv");
    var emptyState = document.getElementById("emptyState");
    var hintArea = document.getElementById("hintArea");
    var nameInput = document.getElementById("nameInput");
    var nameClear = document.getElementById("nameClear");

    function escapeHtml(str) {
        var div = document.createElement('div');
        div.appendChild(document.createTextNode(str));
        return div.innerHTML;
    }

    function getSearchTerm() {
        return searchMode === "category" ? selectedCategory : (nameInput.value || "").trim();
    }

    function updateUI() {
        document.getElementById("locationWrapper").classList.toggle("hidden", shopType !== "physical");
        document.getElementById("searchModeWrapper").classList.toggle("hidden", !shopType);
        document.getElementById("categoryWrapper").classList.toggle("hidden", !shopType || searchMode !== "category");
        document.getElementById("nameWrapper").classList.toggle("hidden", !shopType || searchMode !== "name");

        document.getElementById("btnPhysical").classList.toggle("active", shopType === "physical");
        document.getElementById("btnOnline").classList.toggle("active", shopType === "online");
        document.getElementById("btnCategory").classList.toggle("active", searchMode === "category");
        document.getElementById("btnName").classList.toggle("active", searchMode === "name");

        var term = getSearchTerm();
        var canSearch = term && shopType && (shopType === "online" || selectedLocation);
        searchBtn.disabled = !canSearch || isSearching;
        searchBtn.textContent = isSearching ? "Searching..." : "Search";

        var hint = "";
        if (!shopType) hint = "Choose a shop type above to get started";
        else if (shopType === "physical" && !selectedLocation && term) hint = "Select a location to search for physical shops";
        hintArea.innerHTML = hint ? '<p class="hint">' + hint + '</p>' : '';
    }

    // Shop type buttons
    document.getElementById("btnPhysical").addEventListener("click", function() { shopType = "physical"; updateUI(); });
    document.getElementById("btnOnline").addEventListener("click", function() { shopType = "online"; updateUI(); });

    // Search mode buttons
    document.getElementById("btnCategory").addEventListener("click", function() { searchMode = "category"; updateUI(); });
    document.getElementById("btnName").addEventListener("click", function() { searchMode = "name"; updateUI(); });

    // Shop name input
    nameInput.addEventListener("input", function() {
        nameClear.style.display = nameInput.value ? "block" : "none";
        updateUI();
    });
    nameClear.addEventListener("click", function() { nameInput.value = ""; nameClear.style.display = "none"; updateUI(); });

    // Dropdown setup
    function setupDropdown(inputEl, listEl, clearEl, items, onSelect, getSelected) {
        function render(filter) {
            var f = (filter || "").toLowerCase();
            var matched = items.filter(function(item) { return item.toLowerCase().indexOf(f) !== -1; });
            if (matched.length === 0) {
                listEl.innerHTML = '<div class="dropdown-empty">No matches</div>';
            } else {
                listEl.innerHTML = matched.map(function(item) {
                    return '<div class="dropdown-item">' + escapeHtml(item) + '</div>';
                }).join("");
                listEl.querySelectorAll(".dropdown-item").forEach(function(el) {
                    el.addEventListener("mousedown", function(e) {
                        e.preventDefault();
                        onSelect(el.textContent);
                        inputEl.value = el.textContent;
                        clearEl.style.display = "block";
                        listEl.classList.remove("open");
                        updateUI();
                    });
                });
            }
        }
        inputEl.addEventListener("focus", function() { inputEl.value = ""; render(""); listEl.classList.add("open"); });
        inputEl.addEventListener("input", function() { render(inputEl.value); listEl.classList.add("open"); });
        inputEl.addEventListener("blur", function() {
            setTimeout(function() {
                listEl.classList.remove("open");
                var sel = getSelected();
                if (sel) { inputEl.value = sel; clearEl.style.display = "block"; }
                else { inputEl.value = ""; clearEl.style.display = "none"; }
            }, 150);
        });
        clearEl.addEventListener("click", function() { onSelect(""); inputEl.value = ""; clearEl.style.display = "none"; updateUI(); });
    }

    setupDropdown(
        document.getElementById("locationInput"), document.getElementById("locationList"), document.getElementById("locationClear"),
        UK_LOCATIONS, function(val) { selectedLocation = val; }, function() { return selectedLocation; }
    );
    setupDropdown(
        document.getElementById("categoryInput"), document.getElementById("categoryList"), document.getElementById("categoryClear"),
        CATEGORIES, function(val) { selectedCategory = val; }, function() { return selectedCategory; }
    );

    // Worker search
    async function searchWorker(query, limit) {
        limit = limit || RESULT_LIMIT;
        try {
            var response = await fetch(WORKER_URL, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ query: query, limit: limit })
            });
            var data = await response.json();
            if (data.error) return [];
            return (data.results || []).slice(0, limit);
        } catch (e) { return []; }
    }

    // Render card (unified - icon for physical, url for online)
    function renderCard(r, icon) {
        var iconHtml = icon ? '<div class="category-icon">' + icon + '</div>' : '';
        var urlHtml = icon ? '' : '<div class="result-url">' + escapeHtml(r.displayUrl || r.url) + '</div>';
        return '<a href="' + r.url + '" target="_blank" rel="noopener noreferrer" class="result-card">' +
            iconHtml +
            '<div class="card-text">' +
                '<div class="result-name">' + escapeHtml(r.name) + '</div>' +
                '<div class="result-snippet">' + escapeHtml(r.snippet) + '</div>' +
                urlHtml +
            '</div></a>';
    }

    function renderSectionHeader(icon, title, color, id) {
        return '<div class="section-header">' +
            '<span class="section-icon" style="background:' + color + '15;">' + icon + '</span>' +
            '<div><div class="section-title">' + title + '</div>' +
            '<div class="section-count" id="count-' + id + '">Searching...</div></div>' +
            '<div class="spinner" id="spinner-' + id + '" style="border-top-color:' + color + ';"></div></div>';
    }

    function updateSection(id, count) {
        var countEl = document.getElementById("count-" + id);
        var spinnerEl = document.getElementById("spinner-" + id);
        if (countEl) countEl.textContent = count + " result" + (count !== 1 ? "s" : "") + " found";
        if (spinnerEl) spinnerEl.remove();
    }

    // Main search
    searchBtn.addEventListener("click", async function() {
        var term = getSearchTerm();
        if (!term || !shopType || isSearching) return;
        if (shopType === "physical" && !selectedLocation) return;

        isSearching = true;
        updateUI();
        emptyState.style.display = "none";

        var sectionIcon = shopType === "physical" ? "üè™" : "üåê";
        var sectionTitle = shopType === "physical" ? "Shops in " + escapeHtml(selectedLocation) : "Online shops";
        var sectionColor = shopType === "physical" ? "#2ecc71" : "#8e44ad";

        resultsDiv.innerHTML = renderSectionHeader(sectionIcon, sectionTitle, sectionColor, "results") +
            '<div id="results-list"></div>';

        var query, results;
        if (shopType === "physical") {
            query = searchMode === "category" ? selectedLocation + " " + term : term;
            results = await searchWorker(query, RESULT_LIMIT);
            var icon = CATEGORY_ICONS[term] || "üõçÔ∏è";
            updateSection("results", results.length);
            document.getElementById("results-list").innerHTML = results.length > 0
                ? results.map(function(r) { return renderCard(r, icon); }).join("")
                : '<p class="no-results">No results found. Try a different search.</p>';
        } else {
            query = "site:etsy.com/uk/shop " + term;
            var raw = await searchWorker(query, RESULT_LIMIT);
            results = raw
                .map(function(item) {
                    var url = item.url || "";
                    var m = url.match(/etsy\.com(?:\/uk)?\/shop\/([A-Za-z0-9_]+)/);
                    if (m) url = "https://www.etsy.com/uk/shop/" + m[1];
                    return { name: item.name, snippet: item.snippet, url: url };
                })
                .filter(function(item) { return /etsy\.com.*\/shop\//.test(item.url); })
                .map(function(item) {
                    return { name: item.name, snippet: item.snippet, displayUrl: item.url, url: etsyAffiliateUrl(item.url) };
                });
            updateSection("results", results.length);
            document.getElementById("results-list").innerHTML = results.length > 0
                ? results.map(function(r) { return renderCard(r, null); }).join("")
                : '<p class="no-results">No results found. Try a different search.</p>';
        }

        isSearching = false;
        updateUI();
    });

    updateUI();
    </script>
</body>
</html>
